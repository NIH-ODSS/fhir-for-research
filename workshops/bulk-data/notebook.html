<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>FHIR for Research Workshop - Bulk Data – FHIR® for Research</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dece3bd051e391dd7205a6b15f93dc59.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-ed04999718f06b735b1f8009dce43b94.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-416da0712179dc1ff0278a6ba892b12c.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-360c049c7bc2ff2c1f0b1e1328e2ba2f.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<!-- head.html -->
<!-- any content in this file is inserted into <head></head> -->

<script src="../../modules/mappings.js"></script>

<script>
// test if local storage is available and inititilize global variable store, code adapted from:
// https://developer.mozilla.org/en-US/docs/Web/API/Web_Storage_API/Using_the_Web_Storage_API
function initLocalStorage() {
  let storage;
  try {
    storage = window["localStorage"];
    const x = "__storage_test__";
    storage.setItem(x, x);
    storage.removeItem(x);
    return storage;
  } catch (e) {
    console.log("Error: local storage unavailable.");
    return (
      e instanceof DOMException &&
      // everything except Firefox
      (e.code === 22 ||
        // Firefox
        e.code === 1014 ||
        // test name field too, because code might not be present
        // everything except Firefox
        e.name === "QuotaExceededError" ||
        // Firefox
        e.name === "NS_ERROR_DOM_QUOTA_REACHED") &&
          // acknowledge QuotaExceededError only if there's something already stored
          storage &&
          storage.length !== 0
    );
  }
}

var store = initLocalStorage();
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
<link href="https://fonts.googleapis.com/css2?family=Yantramanav:wght@100;300;400;500;700;900&amp;display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="FHIR for Research Workshop - Bulk Data – FHIR® for Research">
<meta property="og:description" content="">
<meta property="og:site_name" content="FHIR® for Research">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../..">
    <span class="navbar-title">FHIR® for Research</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../sections/introduction"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sections/advanced-topics"> 
<span class="menu-text">Advanced Topics</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sections/hands-on-practice"> 
<span class="menu-text">Hands-on Practice</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../sections/hosting-your-own-workshop"> 
<span class="menu-text">Hosting Your Own Workshop</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../contribute"> 
<span class="menu-text">Questions &amp; Contributions</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/NIH-ODSS/fhir-for-research"> <i class="bi bi-github" role="img" aria-label="View the GitHub repository for this site">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#learning-objectives-and-key-concepts" id="toc-learning-objectives-and-key-concepts" class="nav-link" data-scroll-target="#learning-objectives-and-key-concepts">Learning Objectives and Key Concepts</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  </ul></li>
  <li><a href="#getting-our-access-token" id="toc-getting-our-access-token" class="nav-link" data-scroll-target="#getting-our-access-token">Getting our Access Token</a></li>
  <li><a href="#starting-checking-and-downloading-the-export" id="toc-starting-checking-and-downloading-the-export" class="nav-link" data-scroll-target="#starting-checking-and-downloading-the-export">Starting, Checking, and Downloading the Export</a></li>
  <li><a href="#converting-to-dataframes" id="toc-converting-to-dataframes" class="nav-link" data-scroll-target="#converting-to-dataframes">Converting to DataFrames</a></li>
  <li><a href="#bringing-it-all-together" id="toc-bringing-it-all-together" class="nav-link" data-scroll-target="#bringing-it-all-together">Bringing it all together</a></li>
  <li><a href="#group-export" id="toc-group-export" class="nav-link" data-scroll-target="#group-export">Group export</a></li>
  <li><a href="#creating-fhirpaths" id="toc-creating-fhirpaths" class="nav-link" data-scroll-target="#creating-fhirpaths">Creating FHIRPaths</a></li>
  <li><a href="#testing-with-synthea-data" id="toc-testing-with-synthea-data" class="nav-link" data-scroll-target="#testing-with-synthea-data">Testing with Synthea data</a>
  <ul class="collapse">
  <li><a href="#try-it-yourself" id="toc-try-it-yourself" class="nav-link" data-scroll-target="#try-it-yourself">Try it yourself</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/nih-odss/fhir-for-research/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"><h1 class="title display-7">FHIR for Research Workshop - Bulk Data</h1></header>

<header id="title-block-header">
<!--
-->



</header>

<!-- Begin learning objectives block -->


<!-- End learning objectives block -->

<!-- Hack to add key points block at end of page-->
<!-- End hack to add key points block at end of page-->

<!-- Reading time logic -->



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="learning-objectives-and-key-concepts" class="level3">
<h3 class="anchored" data-anchor-id="learning-objectives-and-key-concepts">Learning Objectives and Key Concepts</h3>
<p><strong>The goal of this workshop is to connect to the SMART Bulk Data Server and fetch a set of sample patient data.</strong></p>
<p>In this exercise, you will:</p>
<ul>
<li>Connect to an authorization server using a provided key, and retrieve an access token</li>
<li>Make a Bulk Data Export Request with that access token</li>
<li>Download the exported Bulk Data</li>
<li>Convert the downloaded data into DataFrames</li>
</ul>
<p>While libraries like <a href="https://github.com/UMEssen/FHIR-PYrate">FHIR-PYrate</a> allow you to fetch data from a server and parse it directly into a DataFrame, these libraries generally do not support FHIR Bulk Data. This workshop will step through the process of building up a tool to fetch Bulk Data and convert it into DataFrames.</p>
<p>This notebook is best experienced interactively. If the notebook already has output in it, you may clear that prior to starting via the menu: Cell -&gt; All Output -&gt; Clear.</p>
</section>
<section id="setup" class="level3">
<h3 class="anchored" data-anchor-id="setup">Setup</h3>
<p>If you are not using a JupyterHub instance with dependencies already installed, you will need to:</p>
<ol type="1">
<li>Clone this repository</li>
<li>Install dependencies with <code>pip install -r requirements.txt</code></li>
<li>Run <code>jupyter notebook workshops/fhir-bulk-data</code></li>
</ol>
<p>This should open the Jupyter environment in your browser window. You should see <code>notebook.ipynb</code> listed in the interface. Open this notebook in Jupyter, and you should be able to run the code.</p>
</section>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>The <a href="http://hl7.org/fhir/uv/bulkdata/">Bulk Data Access standard</a> enables researchers to retrieve large volumes of data from a patient population in an EHR. The Bulk Data Access standard is part of the <a href="https://smarthealthit.org/">SMART ecosystem</a>, and SMART on FHIR can be used to authenticate and authorize applications that retrieve bulk data automatically</p>
<p>Clients of FHIR Bulk Data servers use <a href="http://www.hl7.org/fhir/smart-app-launch/backend-services.html">SMART Backend Authorization</a> to connect to the server. With SMART Backend Authorization, registered clients make a signed request to a token endpoint to receive a Bearer token, which they use for subsequent calls to the FHIR server.</p>
<p>Client registration often happens manually as a separate one-time event. The SMART Backend Authorization specification does not define an API for registration.</p>
<p>For this workshop, we connect to the <a href="https://bulk-data.smarthealthit.org/">SMART Bulk Data Server</a> (<a href="https://bulk-data.smarthealthit.org" class="uri">https://bulk-data.smarthealthit.org</a>). This is a developer tool provided by SMART Health IT to facilitate development with Bulk Data Access. This test server allows clients to “register” on the launch page by providing either a URL for a <a href="https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-sets">JSON Web Key Set(JWKS)</a> or a raw JWKS. In this case, “registration” is not stored on the server. Instead, the FHIR Server URL contains the “registration” information stored as state in the URL and clientID. Production servers will usually have a more standard registration process rather than taking this approach.</p>
<p>For convenience, the SMART Bulk Data Server launch page allows users to generate a one-off JWKS to use for testing. For production usage, clients must generate their own certificates and JWKS and keep the private key private. In this workshop, we will use a JWKS generated by the launch page.</p>
<p><strong>IMPORTANT</strong>: this workshop is not meant to be a formal documentation of the specification, and largely skips error handling and stays on the “happy path” for brevity and readability. We strongly recommend reviewing the specifications and adding error handling before using any of this code in a production environment.</p>
<div id="0d3b3991" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The default style for rendering JSON parsed as Python dicts isn't the best.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use this import and call `print(json)` when we want a cleaner view.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Status bars for long-running cels</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.notebook <span class="im">import</span> trange, tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="getting-our-access-token" class="level2">
<h2 class="anchored" data-anchor-id="getting-our-access-token">Getting our Access Token</h2>
<p>The first step in obtaining data from a FHIR server that supports Bulk Data Access is to obtain an access token. That access token identifies and authorizes the client on requests made to the FHIR resource server.</p>
<p>Obtaining an access token is itself a two-step process: 1. Make a discovery request to the FHIR resource server to get the address of the authorization server. 2. Post a token request, signed by the client’s private key, to the authorization server</p>
<p>To keep the focus of this workshop on the Bulk Data process rather than the details of generating keys, we will use a JWKS pre-generated by the SMART Bulk Data server launch page.</p>
<p>For reference, the steps followed to generate the keys used here were:</p>
<ul>
<li>Visit the SMART Bulk Data Server launch page</li>
<li>In the upper left, click the <code>JWKS</code> button for Authentication</li>
<li>Click the <code>Generate</code> button and choose <code>Generate RS384</code></li>
<li>Choose <code>R4</code> for the FHIR Version</li>
<li>The associated text box now contains a JWKS with both a public and private key, and the Launch Configuration contains a FHIR Server URL and Client ID</li>
<li>Convert the private key from the JWKS to “PEM” format so it can be used by Python (this is not easy to do natively in Python, so we have done it with JavaScript out of band)</li>
</ul>
<p>Let’s start by defining our credentials. <strong>In practice, real credentials must always be stored and loaded securely</strong>, but for simplicity in this workshop we will define them as local variables.</p>
<div id="932a50fe" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>client_id <span class="op">=</span> <span class="st">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InJlZ2lzdHJhdGlvbi10b2tlbiJ9.eyJqd2tzIjp7ImtleXMiOlt7Imt0eSI6IlJTQSIsImFsZyI6IlJTMzg0IiwibiI6IngzMDc2RTJNaUpMR3JPbXJXRjZXSWZ1RjFSZDBlTjBSdEhUSVRuMlNGVWhMYTFQWE5Ia0xBR2xSSmtJWk1QMUk5SEhxdTRERy02d2JraFMweU9GbEZhZE1iaGgzcHkySHoybDctRmg1M3Y3bmpwb3dxUGV2eEpqMlpEQU5BanFWeHRLOGdvMm1BZmZFSnJ2ZkVHbm5oUGkzdGE1U2U5UTBkS29la2hJRVRCaVJTa0ozN0pobEZGSDh3S2hFLXVwaXBQU3VycTBrQ0JkNlNaS3NOVHpHNzJmLVJoNENiREZWTVdfRm5zcTh5LWRJMTdMSDJZcHBBLWc0eGlUZnMwMGZOUG9FUEdoWFU2bHFKMHMwclp4Um9zYnVuV0NTYi1UaEtWV0RyeUFudE83S3dWN1BxVG1NMmVrVS1yenZFaWprVjZfUUlnVTJxRTd6X1k1N1l4aW8zUSIsImUiOiJBUUFCIiwia2V5X29wcyI6WyJ2ZXJpZnkiXSwiZXh0Ijp0cnVlLCJraWQiOiI0ZDc3OTJjZTQyMDU0ZDVkZjhkZDg1ZjhiNTI3ZGQ4OCJ9LHsia3R5IjoiUlNBIiwiYWxnIjoiUlMzODQiLCJuIjoieDMwNzZFMk1pSkxHck9tcldGNldJZnVGMVJkMGVOMFJ0SFRJVG4yU0ZVaExhMVBYTkhrTEFHbFJKa0laTVAxSTlISHF1NERHLTZ3YmtoUzB5T0ZsRmFkTWJoaDNweTJIejJsNy1GaDUzdjduanBvd3FQZXZ4SmoyWkRBTkFqcVZ4dEs4Z28ybUFmZkVKcnZmRUdubmhQaTN0YTVTZTlRMGRLb2VraElFVEJpUlNrSjM3SmhsRkZIOHdLaEUtdXBpcFBTdXJxMGtDQmQ2U1pLc05Uekc3MmYtUmg0Q2JERlZNV19GbnNxOHktZEkxN0xIMllwcEEtZzR4aVRmczAwZk5Qb0VQR2hYVTZscUowczByWnhSb3NidW5XQ1NiLVRoS1ZXRHJ5QW50TzdLd1Y3UHFUbU0yZWtVLXJ6dkVpamtWNl9RSWdVMnFFN3pfWTU3WXhpbzNRIiwiZSI6IkFRQUIiLCJkIjoiUnptQWRTMlMtb1FsS1VGNHF1R0Npdm1KekE1R3lJeHRzTmR0V1JEZVluamdiSjZQbksyRzd3dXJMSlMyOTlYSEFYZld6a0ZwU2h3bDc5OHl1UEk0ckNXQ1ZXQ29fLWh5ci14Q2xlWEpCWVJQV292VXljODlVMTBsdzVtZ1cyWmRhWkotT2NLblBkYWZreERLME1wdkhmdkxZN09zd1lkX2Z4UHFQRTd3ZDlaQU5XLUIyWmNURUVmd2taNWdlcmtDdnFHQ1lEUTdVcVJqR3k1dWRjTkRiQ01ITFdGaEZZMTVqMDVMMFpJV0RwUDY2cmN6UWZEdnduR0pIbWxJbnJMbTl5WkowUTNkVlpHSmo2Y2dMeWI4WHhkNHpWRjZGSy1NX2VKbnFzZFRveHRPMDNUOVotSWlrN1BfbFBheWRvMWRycXRZdUxmZXpvU1lnUGp0V0NnV0JRIiwicCI6IjZwNlV5aGZiQ0JjQlEzcGttMHZEb1lqSDZsc1FCeS1PTzlEYlpfZnFfSHpzZl96UWhENDdua0dZZngxbGVTUFlQU0ZSeDlRTUR3cTlvYWxjYmEwNmE3QTVmMUxQNVpaRnNvSDVCTElHTUcxNmhDbW1mTEdRMURkZ3pMb2s3Q3RldDRnNGhUTlpseFZOYV9uYVNmZGJSdmQycF8zNTM1RGpaOXoyMEpSNllDYyIsInEiOiIyYXNhQ0RCTmY3NTQ1ajdOcXI2TTZiUW8wVGZEWGNlb2FxcGVtNGhpNE1pYUtBOEcydVFvdXNTOGcyUTlZOFZiZmxjX3I2WmxPVjIxSmJhYW5WN253MDRxbVpqMG5Xdkk0a19yX2lKWTVuSDNUMHk0Y0lGV21tLUhPY1dzazJXWl9QQ1NSc1piOU1qOUs4UXh6b1h5WEo0ck9aLUw4OTNZbDZ5bVdKa2xqVnMiLCJkcCI6Ik9LeWI5b0Z5dUc2T01KV2xMZHBNWkgzZEJPQ0FhNnZ5S01MWDdUSjNBZ3pQT0UtQ3N4OHhXWll3MXl2cnNpcVZkcGJRNFh0NGVqMjI5eEVwTVpreHpvZWdMQUItRmRDSl80Zmo5bDFtbjFZaXpVQWVabXFpT0pFMEFlQkpRUDlzX3RxYUJKc1YzaWdZTHFnSk1lcmRrclAtWnJBMEp1d2g4cG51eVEzRXplcyIsImRxIjoib2I2R0FvMjZHUEcxcnduLUZDR3lYanMwbFhzRlhwdHRaNDJmN1owa05IcDhLc1kzeHRJQl9mOFJRZVZyeE1hem5TZENPTWpCc1NZVDVLbFRMUnVIeHRZX3k1RWdQQllLMlRpZ1dXQzJoTTh0QWEwMTVNd0hTWTBVZ19hQ3JhaXpDNFRNZlhFS2hkUVFaTVJPYW5PWVRBQndpRW9wV2hhQXl2eE5ROHJSWDc4IiwicWkiOiJLSjhJU0RKaHVyUmEyTVRHdG4zWjR3NU9ob3o2N29OcE10MG1TakxGUEt0QjFWbjRaZ3VkTUxfWTZ4V2lWTnBOR1hQa3hoMEJjRmNKakNKcC0yeUZLV0d4Si14M2JMWVllbkVUaGRFSGRRR0xuUUszMHlEdHFTY2NDUVY5U2xGc281NUdnUmxhODNaY2NBZTdBMXBWN2sxRGE4dFVFNkE4TXNlQ1ZXamRLbFUiLCJrZXlfb3BzIjpbInNpZ24iXSwiZXh0Ijp0cnVlLCJraWQiOiI0ZDc3OTJjZTQyMDU0ZDVkZjhkZDg1ZjhiNTI3ZGQ4OCJ9XX0sImFjY2Vzc1Rva2Vuc0V4cGlyZUluIjoxNSwiaWF0IjoxNjg2NjUyNzM4fQ.j1urst068-21CxiH0Nqml7XoE9v6hWJ_vfqAK4W22vg'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Don't worry! This is not anybody's real private key. It was generated specifically and only for this exercise.</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>private_key <span class="op">=</span> <span class="st">"""-----BEGIN RSA PRIVATE KEY-----</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="st">MIIEowIBAAKCAQEAx3076E2MiJLGrOmrWF6WIfuF1Rd0eN0RtHTITn2SFUhLa1PX</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="st">NHkLAGlRJkIZMP1I9HHqu4DG+6wbkhS0yOFlFadMbhh3py2Hz2l7+Fh53v7njpow</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="st">qPevxJj2ZDANAjqVxtK8go2mAffEJrvfEGnnhPi3ta5Se9Q0dKoekhIETBiRSkJ3</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="st">7JhlFFH8wKhE+upipPSurq0kCBd6SZKsNTzG72f+Rh4CbDFVMW/Fnsq8y+dI17LH</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="st">2YppA+g4xiTfs00fNPoEPGhXU6lqJ0s0rZxRosbunWCSb+ThKVWDryAntO7KwV7P</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="st">qTmM2ekU+rzvEijkV6/QIgU2qE7z/Y57Yxio3QIDAQABAoIBAEc5gHUtkvqEJSlB</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="st">eKrhgor5icwORsiMbbDXbVkQ3mJ44Gyej5ythu8LqyyUtvfVxwF31s5BaUocJe/f</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="st">MrjyOKwlglVgqP/ocq/sQpXlyQWET1qL1MnPPVNdJcOZoFtmXWmSfjnCpz3Wn5MQ</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="st">ytDKbx37y2OzrMGHf38T6jxO8HfWQDVvgdmXExBH8JGeYHq5Ar6hgmA0O1KkYxsu</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="st">bnXDQ2wjBy1hYRWNeY9OS9GSFg6T+uq3M0Hw78JxiR5pSJ6y5vcmSdEN3VWRiY+n</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="st">IC8m/F8XeM1RehSvjP3iZ6rHU6MbTtN0/WfiIpOz/5T2snaNXa6rWLi33s6EmID4</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="st">7VgoFgUCgYEA6p6UyhfbCBcBQ3pkm0vDoYjH6lsQBy+OO9DbZ/fq/Hzsf/zQhD47</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="st">nkGYfx1leSPYPSFRx9QMDwq9oalcba06a7A5f1LP5ZZFsoH5BLIGMG16hCmmfLGQ</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="st">1DdgzLok7Ctet4g4hTNZlxVNa/naSfdbRvd2p/3535DjZ9z20JR6YCcCgYEA2asa</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="st">CDBNf7545j7Nqr6M6bQo0TfDXceoaqpem4hi4MiaKA8G2uQousS8g2Q9Y8Vbflc/</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="st">r6ZlOV21JbaanV7nw04qmZj0nWvI4k/r/iJY5nH3T0y4cIFWmm+HOcWsk2WZ/PCS</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="st">RsZb9Mj9K8QxzoXyXJ4rOZ+L893Yl6ymWJkljVsCgYA4rJv2gXK4bo4wlaUt2kxk</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="st">fd0E4IBrq/IowtftMncCDM84T4KzHzFZljDXK+uyKpV2ltDhe3h6Pbb3ESkxmTHO</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="st">h6AsAH4V0In/h+P2XWafViLNQB5maqI4kTQB4ElA/2z+2poEmxXeKBguqAkx6t2S</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="st">s/5msDQm7CHyme7JDcTN6wKBgQChvoYCjboY8bWvCf4UIbJeOzSVewVem21njZ/t</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="st">nSQ0enwqxjfG0gH9/xFB5WvExrOdJ0I4yMGxJhPkqVMtG4fG1j/LkSA8FgrZOKBZ</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="st">YLaEzy0BrTXkzAdJjRSD9oKtqLMLhMx9cQqF1BBkxE5qc5hMAHCISilaFoDK/E1D</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="st">ytFfvwKBgCifCEgyYbq0WtjExrZ92eMOToaM+u6DaTLdJkoyxTyrQdVZ+GYLnTC/</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="st">2OsVolTaTRlz5MYdAXBXCYwiaftshSlhsSfsd2y2GHpxE4XRB3UBi50Ct9Mg7akn</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="st">HAkFfUpRbKOeRoEZWvN2XHAHuwNaVe5NQ2vLVBOgPDLHglVo3SpV</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="st">-----END RSA PRIVATE KEY-----"""</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># note key id is the "kid" field from the JWKS -- it's same for both values of `keys`</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>key_id <span class="op">=</span> <span class="st">"4d7792ce42054d5df8dd85f8b527dd88"</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>server_url <span class="op">=</span> <span class="st">'https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZWwiOjB9/fhir'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will use the <a href="https://requests.readthedocs.io/en/latest/">Requests</a> library for making all HTTP requests, and use a <code>Session</code>, in case we need to persist common settings such as proxy or SSL configuration.</p>
<div id="4d75e66a" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>session <span class="op">=</span> requests.Session()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Turn off SSL verification. Useful when dealing with a corporate proxy with self-signed certificates.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib3.exceptions <span class="im">import</span> InsecureRequestWarning</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>requests.packages.urllib3.disable_warnings(category<span class="op">=</span>InsecureRequestWarning)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>session.verify <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start by confirming we can hit the server via the <code>/metadata</code> endpoint. When connecting to a server for the first time it is generally a good idea to review the metadata to see what the server supports, and that it matches your expectations. In this case, expect to see the name “SMART Sample Bulk Data Server”, and references to “export” operations.</p>
<div id="00ba67df" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/metadata'</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> r.json()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metadata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'resourceType'</span>: <span style="color: #008000; text-decoration-color: #008000">'CapabilityStatement'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'status'</span>: <span style="color: #008000; text-decoration-color: #008000">'active'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'date'</span>: <span style="color: #008000; text-decoration-color: #008000">'2023-06-13T01:26:34+00:00'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'publisher'</span>: <span style="color: #008000; text-decoration-color: #008000">"Boston Children's Hospital"</span>,
    <span style="color: #008000; text-decoration-color: #008000">'kind'</span>: <span style="color: #008000; text-decoration-color: #008000">'instance'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'instantiates'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/CapabilityStatement/bulk-data'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'software'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART Sample Bulk Data Server'</span>, <span style="color: #008000; text-decoration-color: #008000">'version'</span>: <span style="color: #008000; text-decoration-color: #008000">'2.1.1'</span><span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'implementation'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'description'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART Sample Bulk Data Server'</span><span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'fhirVersion'</span>: <span style="color: #008000; text-decoration-color: #008000">'4.0.1'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'acceptUnknown'</span>: <span style="color: #008000; text-decoration-color: #008000">'extensions'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'format'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'json'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'rest'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'mode'</span>: <span style="color: #008000; text-decoration-color: #008000">'server'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'security'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                            <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'token'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueUri'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/token'</span><span style="font-weight: bold">}</span>,
                            <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'register'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueUri'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/register'</span><span style="font-weight: bold">}</span>
                        <span style="font-weight: bold">]</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'service'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                            <span style="font-weight: bold">{</span>
                                <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/restful-security-service'</span>,
                                <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART-on-FHIR'</span>,
                                <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'SMART-on-FHIR'</span>
                            <span style="font-weight: bold">}</span>
                        <span style="font-weight: bold">]</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'OAuth2 using SMART-on-FHIR profile (see http://docs.smarthealthit.org)'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'resource'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Patient'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                                <span style="font-weight: bold">{</span>
                                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                                    <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                                <span style="font-weight: bold">}</span>
                            <span style="font-weight: bold">]</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'patient-export'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/patient-export'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Group'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                                <span style="font-weight: bold">{</span>
                                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                                    <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                                <span style="font-weight: bold">}</span>
                            <span style="font-weight: bold">]</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'group-export'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/group-export'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'OperationDefinition'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'profile'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'reference'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/Profile/OperationDefinition'</span><span style="font-weight: bold">}</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'interaction'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'read'</span><span style="font-weight: bold">}]</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'searchParam'</span>: <span style="font-weight: bold">[]</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>,
            <span style="color: #008000; text-decoration-color: #008000">'operation'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'get-resource-counts'</span>, <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'OperationDefinition/-s-get-resource-counts'</span><span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span>
                            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/capabilitystatement-expectation'</span>,
                            <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'SHOULD'</span>
                        <span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="color: #008000; text-decoration-color: #008000">'export'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'definition'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/uv/bulkdata/OperationDefinition/export'</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>The SMART Backend Authorization specification defines that the token endpoint will be published as part of the FHIR resource server’s SMART metadata, at <code>.well-known/smart-configuration</code>. Let’s fetch that endpoint and review the contents.</p>
<div id="d39d1a9b" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/.well-known/smart-configuration'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>smart_config <span class="op">=</span> r.json()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(smart_config)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/token'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'registration_endpoint'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/auth/register'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint_auth_methods_supported'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'private_key_jwt'</span><span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'token_endpoint_auth_signing_alg_values_supported'</span>: <span style="font-weight: bold">[</span>
        <span style="color: #008000; text-decoration-color: #008000">'HS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'HS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'HS512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'RS512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'ES512'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS256'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS384'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'PS512'</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'scopes_supported'</span>: <span style="font-weight: bold">[</span>
        <span style="color: #008000; text-decoration-color: #008000">'system/*.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Patient.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Encounter.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Condition.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Claim.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ExplanationOfBenefit.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Observation.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Immunization.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DiagnosticReport.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Procedure.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CareTeam.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CarePlan.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/MedicationRequest.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/AllergyIntolerance.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Device.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ImagingStudy.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Organization.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Practitioner.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DocumentReference.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Group.rs'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/*.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Patient.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Encounter.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Condition.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Claim.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ExplanationOfBenefit.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Observation.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Immunization.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DiagnosticReport.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Procedure.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CareTeam.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/CarePlan.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/MedicationRequest.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/AllergyIntolerance.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Device.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/ImagingStudy.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Organization.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Practitioner.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/DocumentReference.read'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'system/Group.read'</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'capabilities'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'permission-v2'</span>, <span style="color: #008000; text-decoration-color: #008000">'permission-v1'</span>, <span style="color: #008000; text-decoration-color: #008000">'client-confidential-asymmetric'</span><span style="font-weight: bold">]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>We care most about the <code>token_endpoint</code> field, which we need to request our JWT. For more information about the other fields, see <a href="http://www.hl7.org/fhir/smart-app-launch/scopes-and-launch-context.html">here</a>.</p>
<div id="c0dcf45e" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>token_endpoint <span class="op">=</span> smart_config[<span class="st">'token_endpoint'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have our token endpoint, so we can make a request to it to get a token. The request follows the <a href="https://datatracker.ietf.org/doc/html/rfc6749#section-4.4">OAuth 2.0 “Client Credentials” flow</a>, using a <a href="https://datatracker.ietf.org/doc/html/rfc7523">JSON Web Token (JWT) assertion</a> containing our client ID and signed with our private key.</p>
<p>📘 <a href="http://www.hl7.org/fhir/smart-app-launch/backend-services.html#obtain-access-token">Read more about the access token request specification</a></p>
<div id="e08062b3" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a JWT client assertion as follows:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iss'</span>: client_id,   <span class="co"># "iss" == "issuer", the client that created this JWT</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sub'</span>: client_id,   <span class="co"># "sub" == "subject", the client that will use the access token</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'aud'</span>: token_endpoint,  <span class="co"># "aud" == "audience", the receiver of this request</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    private_key,  <span class="co"># signed with the private key</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    algorithm<span class="op">=</span><span class="st">'RS384'</span>, <span class="co"># algorithm for the key</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id}) <span class="co"># kid is required for smart bulk data server</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># And then POST it to the token endpont</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.post(token_endpoint, data<span class="op">=</span>{</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>token_response <span class="op">=</span> r.json()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co"># And inspect the response:</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>token_response</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>{'token_type': 'bearer',
 'scope': 'system/*.read',
 'expires_in': 300,
 'access_token': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYmVhcmVyIiwic2NvcGUiOiJzeXN0ZW0vKi5yZWFkIiwiZXhwaXJlc19pbiI6MzAwLCJpYXQiOjE2ODY2NTQzNTIsImV4cCI6MTY4NjY1NDY1Mn0.6VcZfI7YBkrGV7IoIBKmQo2usjrpCkIgmJHx8jFir3g'}</code></pre>
</div>
</div>
<p>Two important fields we need to keep track of are the token itself, and the expire time. Tokens are only valid for a certain amount of time, and once they expire we will need to fetch a new one via the same process as above. <code>expires_in</code> is in seconds from the current time, so we’ll add that to the current time to get a timestamp we can compare against.</p>
<p>Note that for this example we requested and received <code>'scope': 'system/*.read'</code> which allows access to all resource types. In practice, requesting access to all resource types is generally not recommended, and servers do not always support asking for <code>*</code> scopes. Generally it is recommended to request only the minimal level of access necessary.</p>
<div id="4f06a599" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To make this easier for ourselves, let’s package this up into a <code>get_token()</code> function that we can call anytime we need to use a token. If the current token is still valid, use that, or if it has expired, fetch a new one. The logic is exactly the same as the previous steps we just ran:</p>
<div id="59b5fc2c" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_token():</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> token, expire_time</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> datetime.datetime.now() <span class="op">&lt;</span> expire_time:</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the existing token is still valid so return it</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> token</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'iss'</span>: client_id,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sub'</span>: client_id,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'aud'</span>: token_endpoint,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    }, private_key, algorithm<span class="op">=</span><span class="st">'RS384'</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id})</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.post(token_endpoint, data<span class="op">=</span>{</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    token_response <span class="op">=</span> r.json()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> token</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="starting-checking-and-downloading-the-export" class="level2">
<h2 class="anchored" data-anchor-id="starting-checking-and-downloading-the-export">Starting, Checking, and Downloading the Export</h2>
<p>Now that we have an access token, the next step in using Bulk Data is to request the export of data, via a “kick-off request”. This is an asynchronous request – once the request is accepted, instead of returning the results directly, the server response will point to a URL where the client can check the status.</p>
<p>There are three levels of export: - <strong>Patient</strong>, to obtain resources related to all Patients - <strong>Group</strong>, to obtain resources associated with a particular <a href="https://www.hl7.org/fhir/group.html">Group</a> - <strong>System</strong>, to obtain all resources, whether or not they are associated with a patient</p>
<p>For this exercise we will initially only request Patient-level data, but the general process for Groups and System-level data is exactly the same - there is just a different endpoint to hit, and a different set of data will be returned.</p>
<p>There are also a number of parameters that may be set, but to keep things simple we will only use the <code>_type</code> parameter, to request only <code>Patient</code> and <code>Condition</code> resource types.</p>
<p>📘 <a href="http://hl7.org/fhir/uv/bulkdata/export.html#bulk-data-kick-off-request">Read more about the Bulk Data Kick-off Request</a></p>
<p>Let’s make the export request and inspect the response headers. For “Patient” level data, the URL we want to hit is <code>{server}/Patient/$export</code>. Our token is used in the “Authorization” header in the format <code>"Bearer {token}"</code>.</p>
<div id="c12edfda" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/Patient/$export?_type=Patient,Condition'</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Prefer'</span>: <span class="st">'respond-async'</span>})</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.headers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Location'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/fhir/bulkstatus/55e2770a4b9c3f861f002634bd44ac62'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Type'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'application/json; charset=utf-8'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'644'</span>, <span style="color: #008000; text-decoration-color: #008000">'Etag'</span>: <span style="color: #008000; text-decoration-color: #008000">'W/"284-G8JHR+JPFTg+y5JhfrRbOzc4ZMI"'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:05:52 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>We see the status URL in the <code>Content-Location</code> header, so let’s save that into a variable.</p>
<div id="a7bdf84f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>check_url <span class="op">=</span> r.headers[<span class="st">'Content-Location'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now check the status by getting that URL, and the HTTP status code of the response will indicate the exort status. - Code <strong>200</strong> means the export is complete, and the response body will indicate the location - Code <strong>202</strong> means the export is still in progress - Codes in the range <strong>4xx-5xx</strong> indicate an error has occurred. 4xx codes generally indicate an error in the request, and 5xx codes generally indicate a server error.</p>
<p>Note that in production environments it is recommended to check the status as infrequently as possible, to minimize the load on the server. In this case we expect the export to complete in just a few seconds so the impact of checking every two seconds is minimal. The server will also include a “Retry-After” header which will give us a hint on how long to wait before trying again. We’ll check that status in a loop, and break out of the loop when we get a complete or error response. We’ll print status each time through the loop, and the response body when the export is complete.</p>
<div id="50ab1b5b" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we check the status in a loop</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.get(check_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> r.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># complete</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> r.json()</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(response)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> r.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in progress</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r.headers)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>        delay <span class="op">=</span> r.headers[<span class="st">'Retry-After'</span>]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Sleeping </span><span class="sc">{</span>delay<span class="sc">}</span><span class="ss"> seconds before retrying"</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        sleep(<span class="bu">int</span>(delay))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># error</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(r.text)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'1% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:05:52 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'21% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:05:54 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'42% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:05:56 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'63% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:05:58 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'Server'</span>: <span style="color: #008000; text-decoration-color: #008000">'Cowboy'</span>, <span style="color: #008000; text-decoration-color: #008000">'Connection'</span>: <span style="color: #008000; text-decoration-color: #008000">'keep-alive'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Powered-By'</span>: <span style="color: #008000; text-decoration-color: #008000">'Express'</span>, <span style="color: #008000; text-decoration-color: #008000">'X-Progress'</span>: <span style="color: #008000; text-decoration-color: #008000">'83% complete, currenly </span>
<span style="color: #008000; text-decoration-color: #008000">processing Patient resources'</span>, <span style="color: #008000; text-decoration-color: #008000">'Retry-After'</span>: <span style="color: #008000; text-decoration-color: #008000">'2'</span>, <span style="color: #008000; text-decoration-color: #008000">'Date'</span>: <span style="color: #008000; text-decoration-color: #008000">'Tue, 13 Jun 2023 11:06:00 GMT'</span>, <span style="color: #008000; text-decoration-color: #008000">'Content-Length'</span>: <span style="color: #008000; text-decoration-color: #008000">'0'</span>, 
<span style="color: #008000; text-decoration-color: #008000">'Via'</span>: <span style="color: #008000; text-decoration-color: #008000">'1.1 vegur'</span><span style="font-weight: bold">}</span>
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Sleeping <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span> seconds before retrying
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'transactionTime'</span>: <span style="color: #008000; text-decoration-color: #008000">'1686654352606'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'request'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZW</span>
<span style="color: #008000; text-decoration-color: #008000">wiOjB9/fhir/Patient/$export?_type=Patient,Condition'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'requiresAccessToken'</span>: <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>,
    <span style="color: #008000; text-decoration-color: #008000">'output'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Condition'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'count'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">639</span>,
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJpZCI6IjU1ZTI3NzBhNGI5YzNmODYxZjAwMjYzNGJkNDRhYzYyIiwib2Zmc2V0IjowLCJsaW1pdC</span>
<span style="color: #008000; text-decoration-color: #008000">I6NjM5LCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Condition.ndjson'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="color: #008000; text-decoration-color: #008000">'Patient'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'count'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">100</span>,
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: 
<span style="color: #008000; text-decoration-color: #008000">'https://bulk-data.smarthealthit.org/eyJpZCI6IjU1ZTI3NzBhNGI5YzNmODYxZjAwMjYzNGJkNDRhYzYyIiwib2Zmc2V0IjowLCJsaW1pdC</span>
<span style="color: #008000; text-decoration-color: #008000">I6MTAwLCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Patient.ndjson'</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'deleted'</span>: <span style="font-weight: bold">[]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'error'</span>: <span style="font-weight: bold">[]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>We can see that the response points us to one or more NDJSON (Newline Delimited JSON) files per resource type, in the <code>output</code> field of the response.</p>
<p>Note that in this case the volume of data is relatively small, and there is only one entry in the list per resource type, but for large datasets it is possible that there could be multiple files (and therefore multiple entries in this list) per resource type.</p>
<p>Let’s save that list to a variable.</p>
<div id="4cfae17a" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>output_files <span class="op">=</span> response[<span class="st">'output'</span>]</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>output_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>[{'type': 'Condition',
  'count': 639,
  'url': 'https://bulk-data.smarthealthit.org/eyJpZCI6IjU1ZTI3NzBhNGI5YzNmODYxZjAwMjYzNGJkNDRhYzYyIiwib2Zmc2V0IjowLCJsaW1pdCI6NjM5LCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Condition.ndjson'},
 {'type': 'Patient',
  'count': 100,
  'url': 'https://bulk-data.smarthealthit.org/eyJpZCI6IjU1ZTI3NzBhNGI5YzNmODYxZjAwMjYzNGJkNDRhYzYyIiwib2Zmc2V0IjowLCJsaW1pdCI6MTAwLCJzZWN1cmUiOnRydWV9/fhir/bulkfiles/1.Patient.ndjson'}]</code></pre>
</div>
</div>
<p>Now we can loop through the list and download each one. Each file is an NDJSON, so that means we’ll see one resource per line.</p>
<p>To make each step clear and distinct, we’ll keep a dict of <code>{ resourceType: [resources,...]}</code> which we can process later.</p>
<p>Note: for this exercise we are only reading the NDJSON files into a dict in memory, but in practice you may want to save the file locally first in case there are errors in processing, especially if the files are large.</p>
<div id="68d72300" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>resources_by_type <span class="op">=</span> {}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> output_file <span class="kw">in</span> tqdm(output_files):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    download_url <span class="op">=</span> output_file[<span class="st">'url'</span>]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    resource_type <span class="op">=</span> output_file[<span class="st">'type'</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> session.get(download_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    ndjson <span class="op">=</span> r.text.strip()  <span class="co"># remove any whitespace, in particular trailing newlines</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> resources_by_type:</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>        resources_by_type[resource_type] <span class="op">=</span> []</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NDJSON can't be parsed as a whole, we have to process it line-by-line</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> ndjson.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>        resource <span class="op">=</span> json.loads(line)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        resources_by_type[resource_type].append(resource)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># This is a large amount of JSON data, only uncomment this line if you care to review</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># print(resources_by_type)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6016387320b344acb502b84f079daa46","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="converting-to-dataframes" class="level2">
<h2 class="anchored" data-anchor-id="converting-to-dataframes">Converting to DataFrames</h2>
<p>Finally, let’s convert these into DataFrames.</p>
<p>The quick-and-dirty option is to use the Pandas <code>json_normalize()</code> function to parse a list of <code>dict</code>s into a DataFrame.</p>
<p>📘 <a href="https://pandas.pydata.org/docs/reference/api/pandas.json_normalize.html">Read more about <code>pandas.json_normalize</code></a></p>
<div id="bc1f745a" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>resource_dfs <span class="op">=</span> {}</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(resources)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we can work with them by type:</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">extension</th>
<th data-quarto-table-cell-role="th">identifier</th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">telecom</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">birthDate</th>
<th data-quarto-table-cell-role="th">address</th>
<th data-quarto-table-cell-role="th">multipleBirthBoolean</th>
<th data-quarto-table-cell-role="th">communication</th>
<th data-quarto-table-cell-role="th">text.status</th>
<th data-quarto-table-cell-role="th">text.div</th>
<th data-quarto-table-cell-role="th">maritalStatus.coding</th>
<th data-quarto-table-cell-role="th">maritalStatus.text</th>
<th data-quarto-table-cell-role="th">multipleBirthInteger</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Patient</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Lemke', 'given...</td>
<td>[{'system': 'phone', 'value': '555-532-1156', ...</td>
<td>male</td>
<td>1965-01-13</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Patient</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Wintheiser', '...</td>
<td>[{'system': 'phone', 'value': '555-712-4709', ...</td>
<td>female</td>
<td>1971-04-05</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Patient</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Alaniz', 'give...</td>
<td>[{'system': 'phone', 'value': '555-446-6900', ...</td>
<td>male</td>
<td>1923-03-24</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Patient</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Walsh', 'given...</td>
<td>[{'system': 'phone', 'value': '555-436-4287', ...</td>
<td>female</td>
<td>1965-10-27</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Patient</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Bednar', 'give...</td>
<td>[{'system': 'phone', 'value': '555-405-4909', ...</td>
<td>female</td>
<td>1942-07-04</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>Patient</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Schmeler', 'gi...</td>
<td>[{'system': 'phone', 'value': '555-971-6300', ...</td>
<td>male</td>
<td>1995-10-19</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>Never Married</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>Patient</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Lubowitz', 'gi...</td>
<td>[{'system': 'phone', 'value': '555-328-5229', ...</td>
<td>male</td>
<td>1956-05-06</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>Patient</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Funk', 'given'...</td>
<td>[{'system': 'phone', 'value': '555-497-7639', ...</td>
<td>male</td>
<td>1966-02-07</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>M</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>Patient</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Bergstrom', 'g...</td>
<td>[{'system': 'phone', 'value': '555-845-1730', ...</td>
<td>male</td>
<td>1990-11-18</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>S</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>Patient</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>[{'url': 'http://hl7.org/fhir/StructureDefinit...</td>
<td>[{'system': 'https://github.com/synthetichealt...</td>
<td>[{'use': 'official', 'family': 'Pagac', 'given...</td>
<td>[{'system': 'phone', 'value': '555-504-1379', ...</td>
<td>female</td>
<td>1968-04-20</td>
<td>[{'extension': [{'url': 'http://hl7.org/fhir/S...</td>
<td>False</td>
<td>[{'language': {'coding': [{'system': 'urn:ietf...</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>[{'system': 'http://terminology.hl7.org/CodeSy...</td>
<td>S</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>100 rows × 16 columns</p>
</div>
</div>
</div>
<p>This works, but it’s clearly not ideal in how it handles nested fields, such as the nested lists of the <code>name</code> field. One way we can do a little better is with the flatten_json library: <a href="https://github.com/amirziai/flatten" class="uri">https://github.com/amirziai/flatten</a></p>
<div id="160fcda7" class="cell" data-scrolled="false" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flatten_json <span class="im">import</span> flatten</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), resources)))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's take another look</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">text_status</th>
<th data-quarto-table-cell-role="th">text_div</th>
<th data-quarto-table-cell-role="th">extension_0_url</th>
<th data-quarto-table-cell-role="th">extension_0_valueString</th>
<th data-quarto-table-cell-role="th">extension_1_url</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_city</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_state</th>
<th data-quarto-table-cell-role="th">extension_1_valueAddress_country</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">multipleBirthBoolean</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_system</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_code</th>
<th data-quarto-table-cell-role="th">communication_0_language_coding_0_display</th>
<th data-quarto-table-cell-role="th">communication_0_language_text</th>
<th data-quarto-table-cell-role="th">name_1_use</th>
<th data-quarto-table-cell-role="th">name_1_family</th>
<th data-quarto-table-cell-role="th">name_1_given_0</th>
<th data-quarto-table-cell-role="th">name_1_prefix_0</th>
<th data-quarto-table-cell-role="th">multipleBirthInteger</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Patient</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Lettie Boyle</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Boston</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Patient</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Marquetta Schamberger</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Macau</td>
<td>Macao Special Administrative Region of the Peo...</td>
<td>CN</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>zh</td>
<td>Chinese</td>
<td>Chinese</td>
<td>maiden</td>
<td>Heathcote</td>
<td>Aleta</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Patient</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Pilar Orta</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>San Jose</td>
<td>San Jose</td>
<td>CR</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>es</td>
<td>Spanish</td>
<td>Spanish</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Patient</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Arvilla Haag</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Norton</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>maiden</td>
<td>Kuphal</td>
<td>Alyce</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Patient</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Marcelina Harber</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Brockton</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>maiden</td>
<td>Runolfsson</td>
<td>Arnette</td>
<td>Mrs.</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>Patient</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Allison Daugherty</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Boston</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>Patient</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Antoinette Parker</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Mansfield</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>Patient</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Barbar Windler</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Randolph</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>Patient</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Juli Johns</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Holyoke</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>Patient</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>generated</td>
<td>&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Gene...</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Lanie Hyatt</td>
<td>http://hl7.org/fhir/StructureDefinition/patien...</td>
<td>Millis</td>
<td>Massachusetts</td>
<td>US</td>
<td>...</td>
<td>False</td>
<td>urn:ietf:bcp:47</td>
<td>en-US</td>
<td>English</td>
<td>English</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>100 rows × 73 columns</p>
</div>
</div>
</div>
<p>Let’s look at just one row so it’s easier to see all the columns and an example value:</p>
<div id="5aa89719" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="dv">1000</span>, <span class="st">'display.max_columns'</span>, <span class="dv">10</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(resource_dfs[<span class="st">'Patient'</span>].loc[<span class="dv">0</span>].T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">resourceType                                                                                Patient
id                                                             <span style="color: #ffff00; text-decoration-color: #ffff00">6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</span>
text_status                                                                               generated
text_div                                          <span style="font-weight: bold">&lt;</span><span style="color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold">div</span><span style="color: #000000; text-decoration-color: #000000"> </span><span style="color: #808000; text-decoration-color: #808000">xmlns</span><span style="color: #000000; text-decoration-color: #000000">=</span><span style="color: #008000; text-decoration-color: #008000">"http://www.w3.org/1999/xhtml"</span><span style="font-weight: bold">&gt;</span>Gene<span style="color: #808000; text-decoration-color: #808000">...</span>
extension_0_url                                   <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://hl7.org/fhir/StructureDefinition/patien...</span>
extension_0_valueString                                                                Lettie Boyle
extension_1_url                                   <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://hl7.org/fhir/StructureDefinition/patien...</span>
extension_1_valueAddress_city                                                                Boston
extension_1_valueAddress_state                                                        Massachusetts
extension_1_valueAddress_country                                                                 US
extension_2_url                                   <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://synthetichealth.github.io/synthea/disab...</span>
extension_2_valueDecimal                                                                   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.305628</span>
extension_3_url                                   <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://synthetichealth.github.io/synthea/quali...</span>
extension_3_valueDecimal                                                                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">53.694372</span>
identifier_0_system                                      <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://github.com/synthetichealth/synthea</span>
identifier_0_value                                             <span style="color: #ffff00; text-decoration-color: #ffff00">6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</span>
identifier_1_type_coding_0_system                     <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://terminology.hl7.org/CodeSystem/v2-0203</span>
identifier_1_type_coding_0_code                                                                  MR
identifier_1_type_coding_0_display                                            Medical Record Number
identifier_1_type_text                                                        Medical Record Number
identifier_1_system                                               <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://hospital.smarthealthit.org</span>
identifier_1_value                                             <span style="color: #ffff00; text-decoration-color: #ffff00">6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</span>
identifier_2_type_coding_0_system                     <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://terminology.hl7.org/CodeSystem/v2-0203</span>
identifier_2_type_coding_0_code                                                                  SS
identifier_2_type_coding_0_display                                           Social Security Number
identifier_2_type_text                                                       Social Security Number
identifier_2_system                                                  <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://hl7.org/fhir/sid/us-ssn</span>
identifier_2_value                                                                      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">999</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8203</span>
identifier_3_type_coding_0_system                     <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://terminology.hl7.org/CodeSystem/v2-0203</span>
identifier_3_type_coding_0_code                                                                  DL
identifier_3_type_coding_0_display                                                 Driver's License
identifier_3_type_text                                                             Driver's License
identifier_3_system                                                urn:oi<span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">d:2</span>.<span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">16.840.1.113883.4.3.25</span>
identifier_3_value                                                                        S99914534
identifier_4_type_coding_0_system                     <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://terminology.hl7.org/CodeSystem/v2-0203</span>
identifier_4_type_coding_0_code                                                                 PPN
identifier_4_type_coding_0_display                                                  Passport Number
identifier_4_type_text                                                              Passport Number
identifier_4_system                               <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://standardhealthrecord.org/fhir/Structure...</span>
identifier_4_value                                                                       X41457228X
name_0_use                                                                                 official
name_0_family                                                                                 Lemke
name_0_given_0                                                                                Abram
name_0_prefix_0                                                                                 Mr.
telecom_0_system                                                                              phone
telecom_0_value                                                                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">555</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">532</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1156</span>
telecom_0_use                                                                                  home
gender                                                                                         male
birthDate                                                                                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1965</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>
address_0_extension_0_url                         <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://hl7.org/fhir/StructureDefinition/geoloc...</span>
address_0_extension_0_extension_0_url                                                      latitude
address_0_extension_0_extension_0_valueDecimal                                            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">42.264144</span>
address_0_extension_0_extension_1_url                                                     longitude
address_0_extension_0_extension_1_valueDecimal                                           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-72.642902</span>
address_0_line_0                                                                  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">167</span> Nikolaus Gate
address_0_city                                                                          Easthampton
address_0_state                                                                       Massachusetts
address_0_postalCode                                                                          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01027</span>
address_0_country                                                                                US
maritalStatus_coding_0_system                     <span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">http://terminology.hl7.org/CodeSystem/v3-Marit...</span>
maritalStatus_coding_0_code                                                                       M
maritalStatus_coding_0_display                                                                    M
maritalStatus_text                                                                                M
multipleBirthBoolean                                                                          <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>
communication_0_language_coding_0_system                                            urn:iet<span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">f:bc</span>p:<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47</span>
communication_0_language_coding_0_code                                                        en-US
communication_0_language_coding_0_display                                                   English
communication_0_language_text                                                               English
name_1_use                                                                                      NaN
name_1_family                                                                                   NaN
name_1_given_0                                                                                  NaN
name_1_prefix_0                                                                                 NaN
multipleBirthInteger                                                                            NaN
Name: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>, dtype: object
</pre>
</div>
</div>
<p>Next, what if we know in advance we will only want certain fields?</p>
<p>Let’s follow the same pattern the FHIR-PYrate library uses, and use <a href="https://hl7.org/fhir/fhirpath.html">FHIRPath</a> to define the fields we want to extract, along with a friendly name. For this we’ll use the <a href="https://github.com/beda-software/fhirpath-py">fhirpathpy</a> library.</p>
<p><a href="http://hl7.org/fhirpath/N1/">FHIRPath is</a>:</p>
<blockquote class="blockquote">
<p>a path based navigation and extraction language, somewhat like XPath. Operations are expressed in terms of the logical content of hierarchical data models, and support traversal, selection and filtering of data.</p>
</blockquote>
<p>If you are not familiar with FHIRPath, <a href="http://hl7.org/fhirpath/N1/#path-selection">Section 3 of the FHIRPath spec</a> describes some of the basics.</p>
<div id="0e16d9c8" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fhirpathpy</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>fhir_paths <span class="op">=</span> [</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>],</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"gender"</span>, <span class="st">"gender"</span>],</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>],</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding.first().code"</span>]</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># compile the fhirpath so they can be reused. this will result in better performance on large datasets</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>     f[<span class="dv">1</span>] <span class="op">=</span> fhirpathpy.<span class="bu">compile</span>(f[<span class="dv">1</span>])</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    filtered_resources <span class="op">=</span> []</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> resource <span class="kw">in</span> resources:</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        filtered_resource <span class="op">=</span> {}</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            fieldname <span class="op">=</span> f[<span class="dv">0</span>]</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>            func <span class="op">=</span> f[<span class="dv">1</span>]</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>            filtered_resource[fieldname] <span class="op">=</span> func(resource)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>            <span class="co"># fhirpathpy always returns a list, which can make the DataFrame messy</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>            <span class="co"># if it's a list with only one item, extract the item from the list</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(filtered_resource[fieldname], <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(filtered_resource[fieldname]) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                filtered_resource[fieldname] <span class="op">=</span> filtered_resource[fieldname][<span class="dv">0</span>]</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        filtered_resources.append(filtered_resource)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    resource_dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), filtered_resources)))</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>resource_dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">date_of_birth</th>
<th data-quarto-table-cell-role="th">marital_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>male</td>
<td>1965-01-13</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>female</td>
<td>1971-04-05</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>male</td>
<td>1923-03-24</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>female</td>
<td>1965-10-27</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>female</td>
<td>1942-07-04</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>male</td>
<td>1995-10-19</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>male</td>
<td>1956-05-06</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>male</td>
<td>1966-02-07</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>male</td>
<td>1990-11-18</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>female</td>
<td>1968-04-20</td>
<td>S</td>
</tr>
</tbody>
</table>

<p>100 rows × 4 columns</p>
</div>
</div>
</div>
</section>
<section id="bringing-it-all-together" class="level2">
<h2 class="anchored" data-anchor-id="bringing-it-all-together">Bringing it all together</h2>
<p>Now we have everything we need to connect to a FHIR server that supports Bulk Data, request and download exported data, and convert it into a DataFrame. Let’s bring everything together from the previous steps into one class with a clear entrypoint.</p>
<div id="561dee3b" class="cell" data-pycharm="{&quot;is_executing&quot;:true}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jwt</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fhirpathpy</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flatten_json <span class="im">import</span> flatten</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BulkDataFetcher:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        base_url: <span class="bu">str</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        client_id: <span class="bu">str</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        private_key: <span class="bu">str</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        key_id: <span class="bu">str</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        endpoint: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        session: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.base_url <span class="op">=</span> base_url</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client_id <span class="op">=</span> client_id</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.private_key <span class="op">=</span> private_key</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.key_id <span class="op">=</span> key_id</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_expire_time <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> endpoint <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.endpoint <span class="op">=</span> <span class="st">"Patient"</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.endpoint <span class="op">=</span> endpoint</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> session <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.session <span class="op">=</span> requests.Session()</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.session <span class="op">=</span> session</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.get(<span class="ss">f'</span><span class="sc">{</span>base_url<span class="sc">}</span><span class="ss">/.well-known/smart-configuration'</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        smart_config <span class="op">=</span> r.json()</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token_endpoint <span class="op">=</span> smart_config[<span class="st">'token_endpoint'</span>]</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resource_types <span class="op">=</span> []</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fhir_paths <span class="op">=</span> {}</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store raw FHIR resource instances; populated as part of get_dataframes()</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resources_by_type <span class="op">=</span> {}</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_token(<span class="va">self</span>):</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.token <span class="kw">and</span> datetime.datetime.now() <span class="op">&lt;</span> <span class="va">self</span>.expire_time:</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># the existing token is still valid so use it</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.token</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>        assertion <span class="op">=</span> jwt.encode({</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">'iss'</span>: <span class="va">self</span>.client_id,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sub'</span>: <span class="va">self</span>.client_id,</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>                <span class="st">'aud'</span>: <span class="va">self</span>.token_endpoint,</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">'exp'</span>: <span class="bu">int</span>((datetime.datetime.now() <span class="op">+</span> datetime.timedelta(minutes<span class="op">=</span><span class="dv">5</span>)).timestamp())</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>        }, <span class="va">self</span>.private_key, algorithm<span class="op">=</span><span class="st">'RS384'</span>,</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        headers<span class="op">=</span>{<span class="st">"kid"</span>: key_id})</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.post(<span class="va">self</span>.token_endpoint, data<span class="op">=</span>{</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">'scope'</span>: <span class="st">'system/*.read'</span>,</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">'grant_type'</span>: <span class="st">'client_credentials'</span>,</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">'client_assertion_type'</span>: <span class="st">'urn:ietf:params:oauth:client-assertion-type:jwt-bearer'</span>,</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">'client_assertion'</span>: assertion</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>        token_response <span class="op">=</span> r.json()</span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.token <span class="op">=</span> token_response[<span class="st">'access_token'</span>]</span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.expire_time <span class="op">=</span> datetime.datetime.now() <span class="op">+</span> datetime.timedelta(seconds<span class="op">=</span>token_response[<span class="st">'expires_in'</span>])</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.token</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_resource_type(<span class="va">self</span>, resource_type: <span class="bu">str</span>, fhir_paths <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resource_types.append(resource_type)</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fhir_paths:</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>            <span class="co"># fhir_paths=[</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>            <span class="co">#    ("id", "identifier[0].value"),</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>            <span class="co">#    ("marital_status", "maritalStatus.coding[0].code")</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ]</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>            compiled_fhir_paths <span class="op">=</span> [(f[<span class="dv">0</span>], fhirpathpy.<span class="bu">compile</span>(f[<span class="dv">1</span>])) <span class="cf">for</span> f <span class="kw">in</span> fhir_paths]</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.fhir_paths[resource_type] <span class="op">=</span> compiled_fhir_paths</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _invoke_request(<span class="va">self</span>):</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>        types <span class="op">=</span> <span class="st">','</span>.join(<span class="va">self</span>.resource_types)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>base_url<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>endpoint<span class="sc">}</span><span class="ss">/$export?_type=</span><span class="sc">{</span>types<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Fetching from </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> <span class="va">self</span>.session.get(url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>, <span class="st">'Prefer'</span>: <span class="st">'respond-async'</span>})</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.check_url <span class="op">=</span> r.headers[<span class="st">'Content-Location'</span>]</span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.check_url</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _wait_until_ready(<span class="va">self</span>):</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> <span class="va">self</span>.session.get(<span class="va">self</span>.check_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># There are three possible options here: http://hl7.org/fhir/uv/bulkdata/export.html#bulk-data-status-request</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Error = 4xx or 5xx status code</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># In-Progress = 202</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Complete = 200</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> r.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>                <span class="co"># complete</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>                response <span class="op">=</span> r.json()</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.output_files <span class="op">=</span> response[<span class="st">'output'</span>]</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">self</span>.output_files</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> r.status_code <span class="op">==</span> <span class="dv">202</span>:</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>                <span class="co"># in progress</span></span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>                delay <span class="op">=</span> r.headers[<span class="st">'Retry-After'</span>]</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>                sleep(<span class="bu">int</span>(delay))</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> <span class="pp">RuntimeError</span>(r.text)</span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_dataframes(<span class="va">self</span>):</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._invoke_request()</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._wait_until_ready()</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>        resources_by_type <span class="op">=</span> {}</span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resources_by_type <span class="op">=</span> {} <span class="co"># Reset store of raw FHIR resources each time this is run</span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> output_file <span class="kw">in</span> <span class="va">self</span>.output_files:</span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>            download_url <span class="op">=</span> output_file[<span class="st">'url'</span>]</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>            resource_type <span class="op">=</span> output_file[<span class="st">'type'</span>]</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> <span class="va">self</span>.session.get(download_url, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>            ndjson <span class="op">=</span> r.text.strip()</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> resources_by_type:</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>                resources_by_type[resource_type] <span class="op">=</span> []</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.resources_by_type[resource_type] <span class="op">=</span> []</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> ndjson.split(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>):</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>                resource <span class="op">=</span> json.loads(line)</span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Make raw resource instances available for future use</span></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.resources_by_type[resource_type].append(resource)</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> resource_type <span class="kw">in</span> <span class="va">self</span>.fhir_paths:</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>                    fhir_paths <span class="op">=</span> <span class="va">self</span>.fhir_paths[resource_type]</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>                    filtered_resource <span class="op">=</span> {}</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> f <span class="kw">in</span> fhir_paths:</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>                        fieldname <span class="op">=</span> f[<span class="dv">0</span>]</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>                        func <span class="op">=</span> f[<span class="dv">1</span>]</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>                        filtered_resource[fieldname] <span class="op">=</span> func(resource)</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(filtered_resource[fieldname], <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(filtered_resource[fieldname]) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>                            filtered_resource[fieldname] <span class="op">=</span> filtered_resource[fieldname][<span class="dv">0</span>]</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>                    resource <span class="op">=</span> filtered_resource</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>                resources_by_type[resource_type].append(resource)</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> {}</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> resource_type, resources <span class="kw">in</span> resources_by_type.items():</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>            dfs[resource_type] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), resources)))</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dfs</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_example_resource(<span class="va">self</span>, resource_type: <span class="bu">str</span>, resource_id: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.resources_by_type <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"You need to run get_dataframes() first"</span>)</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.resources_by_type:</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>resource_type<span class="sc">}</span><span class="ss"> not available. Try one of these: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(<span class="va">self</span>.resources_by_type.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> resource_id <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.resources_by_type[resource_type][<span class="dv">0</span>]</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>        resource <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.resources_by_type[resource_type] <span class="cf">if</span> r[<span class="st">'id'</span>] <span class="op">==</span> resource_id]</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(resource) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> resource[<span class="dv">0</span>]</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"No </span><span class="sc">{</span>resource_type<span class="sc">}</span><span class="ss"> with id=</span><span class="sc">{</span>resource_id<span class="sc">}</span><span class="ss"> was found."</span>)</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reprocess_dataframes(<span class="va">self</span>, fhir_paths):</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BulkDataFetcher._reprocess_dataframes(<span class="va">self</span>.resources_by_type, fhir_paths)</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _reprocess_dataframes(cls, obj_resources_by_type, user_fhir_paths):</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>        parsed_resources_by_type <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> this_resource_type <span class="kw">in</span> obj_resources_by_type.keys():</span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> this_resource_type <span class="kw">in</span> user_fhir_paths:</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>                user_fhir_paths[this_resource_type] <span class="op">=</span> [(f[<span class="dv">0</span>], fhirpathpy.<span class="bu">compile</span>(f[<span class="dv">1</span>])) <span class="cf">for</span> f <span class="kw">in</span> user_fhir_paths[this_resource_type]]</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> resource <span class="kw">in</span> obj_resources_by_type[this_resource_type]:</span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> this_resource_type <span class="kw">in</span> user_fhir_paths:</span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a>                    filtered_resource <span class="op">=</span> {}</span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> f <span class="kw">in</span> user_fhir_paths[this_resource_type]:</span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>                        fieldname <span class="op">=</span> f[<span class="dv">0</span>]</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a>                        func <span class="op">=</span> f[<span class="dv">1</span>]</span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a>                        filtered_resource[fieldname] <span class="op">=</span> func(resource)</span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="bu">isinstance</span>(filtered_resource[fieldname], <span class="bu">list</span>) <span class="kw">and</span> <span class="bu">len</span>(filtered_resource[fieldname]) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>                            filtered_resource[fieldname] <span class="op">=</span> filtered_resource[fieldname][<span class="dv">0</span>]</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>                    parsed_resources_by_type[this_resource_type].append(filtered_resource)</span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>                    parsed_resources_by_type[this_resource_type].append(resource)</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>        dfs <span class="op">=</span> {}</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t, res <span class="kw">in</span> parsed_resources_by_type.items():</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>            dfs[t] <span class="op">=</span> pd.json_normalize(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> r: flatten(r), res)))</span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> dfs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8079a34b" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># And then to invoke it:</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create a BulkDataFetcher with our credentials</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>fetcher <span class="op">=</span> BulkDataFetcher(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span>server_url, client_id<span class="op">=</span>client_id, private_key<span class="op">=</span>private_key, key_id<span class="op">=</span>key_id, session<span class="op">=</span>session</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># add a resource type of interest, with some FHIRPath field mappings</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Patient'</span>, [</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>),</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"gender"</span>, <span class="st">"gender"</span>),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding.first().code"</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># add another resource type, with no FHIRPath mappings (load the entire resource)</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Condition'</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> fetcher.get_dataframes()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Fetching from 
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZWw</span>
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">iOjB9/fhir/Patient/$export?_type=Patient,Condition</span>
</pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">date_of_birth</th>
<th data-quarto-table-cell-role="th">marital_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>male</td>
<td>1965-01-13</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>58c297c4-d684-4677-8024-01131d93835e</td>
<td>female</td>
<td>1971-04-05</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>538a9a4e-8437-47d3-8c01-1a17dca8f0be</td>
<td>male</td>
<td>1923-03-24</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>c6c60742-8694-46e4-bb42-b00bf6d8b536</td>
<td>female</td>
<td>1965-10-27</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>female</td>
<td>1942-07-04</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>5efb1ac1-d29b-40a5-a3d1-2d682f10bfa7</td>
<td>male</td>
<td>1995-10-19</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>c1981741-f90e-4077-9156-429a3c4c5ded</td>
<td>male</td>
<td>1956-05-06</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>male</td>
<td>1966-02-07</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>c536dee9-9ef6-4807-ae20-9f1045c9c7d6</td>
<td>male</td>
<td>1990-11-18</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>female</td>
<td>1968-04-20</td>
<td>S</td>
</tr>
</tbody>
</table>

<p>100 rows × 4 columns</p>
</div>
</div>
</div>
<div id="64342e0e" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Condition'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">clinicalStatus_coding_0_system</th>
<th data-quarto-table-cell-role="th">clinicalStatus_coding_0_code</th>
<th data-quarto-table-cell-role="th">verificationStatus_coding_0_system</th>
<th data-quarto-table-cell-role="th">verificationStatus_coding_0_code</th>
<th data-quarto-table-cell-role="th">code_coding_0_system</th>
<th data-quarto-table-cell-role="th">code_coding_0_code</th>
<th data-quarto-table-cell-role="th">code_coding_0_display</th>
<th data-quarto-table-cell-role="th">code_text</th>
<th data-quarto-table-cell-role="th">subject_reference</th>
<th data-quarto-table-cell-role="th">encounter_reference</th>
<th data-quarto-table-cell-role="th">onsetDateTime</th>
<th data-quarto-table-cell-role="th">recordedDate</th>
<th data-quarto-table-cell-role="th">abatementDateTime</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Condition</td>
<td>a5a38601-b6fe-46b4-a67e-cde9d5957dde</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>40055000</td>
<td>Chronic sinusitis (disorder)</td>
<td>Chronic sinusitis (disorder)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/17b801ac-58e3-4f6b-8b48-8e33f3a36086</td>
<td>1985-06-18T17:30:49-04:00</td>
<td>1985-06-18T17:30:49-04:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Condition</td>
<td>8f818ad4-c292-47e8-8d99-c4c54174b671</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>162864005</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/0953dd44-90bb-4805-badd-169a761a6ab3</td>
<td>2005-01-19T16:30:49-05:00</td>
<td>2005-01-19T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Condition</td>
<td>65d9d5f2-a772-4586-932f-df1f2ce1a863</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>15777000</td>
<td>Prediabetes</td>
<td>Prediabetes</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/d4e1370a-a679-4570-a3dc-e4f7ac847512</td>
<td>2013-02-06T16:30:49-05:00</td>
<td>2013-02-06T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Condition</td>
<td>77ac8342-6950-4302-a303-efba12e06785</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>68496003</td>
<td>Polyp of colon</td>
<td>Polyp of colon</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/58ad433b-3707-4d40-9b63-2a803b4913bd</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2017-05-03T17:30:49-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Condition</td>
<td>6514ab0c-bc64-4e1b-aa61-b97d27d72bc7</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>271737000</td>
<td>Anemia (disorder)</td>
<td>Anemia (disorder)</td>
<td>Patient/6c5d9ca9-54d7-42f5-bfae-a7c19cd217f2</td>
<td>Encounter/58ad433b-3707-4d40-9b63-2a803b4913bd</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>2015-01-14T16:30:49-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">634</td>
<td>Condition</td>
<td>ab051f6c-4298-407b-9315-2322ce913539</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>active</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>162864005</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Body mass index 30+ - obesity (finding)</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/c5ed8aed-2b7e-4630-bd1d-ac5090967edc</td>
<td>2014-11-22T15:43:42-05:00</td>
<td>2014-11-22T15:43:42-05:00</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">635</td>
<td>Condition</td>
<td>76c1f07a-f8f2-4705-aa80-5f7a25d7c651</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>39848009</td>
<td>Whiplash injury to neck</td>
<td>Whiplash injury to neck</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/9c8b41dd-d6fd-4691-ae46-01b47992dd8d</td>
<td>2015-07-13T16:43:42-04:00</td>
<td>2015-07-13T16:43:42-04:00</td>
<td>2015-08-10T16:43:42-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">636</td>
<td>Condition</td>
<td>b9a078eb-bb83-49ed-b4ed-633d1445356d</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>70704007</td>
<td>Sprain of wrist</td>
<td>Sprain of wrist</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/f044f05a-8433-4952-926d-dd8e2b4ee44e</td>
<td>2018-07-25T16:43:42-04:00</td>
<td>2018-07-25T16:43:42-04:00</td>
<td>2018-08-15T16:43:42-04:00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">637</td>
<td>Condition</td>
<td>0fe427ce-7ea1-4409-8de1-3879f9dc56bb</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>444814009</td>
<td>Viral sinusitis (disorder)</td>
<td>Viral sinusitis (disorder)</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/9100e9aa-1206-403b-b2bf-b75ac23991bd</td>
<td>2018-09-26T16:43:42-04:00</td>
<td>2018-09-26T16:43:42-04:00</td>
<td>2018-10-17T16:43:42-04:00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">638</td>
<td>Condition</td>
<td>88f3f41a-68ec-46dd-8d44-9178d3872220</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>resolved</td>
<td>http://terminology.hl7.org/CodeSystem/conditio...</td>
<td>confirmed</td>
<td>http://snomed.info/sct</td>
<td>72892002</td>
<td>Normal pregnancy</td>
<td>Normal pregnancy</td>
<td>Patient/a845ead4-d9de-42eb-b4b5-eb21a8963578</td>
<td>Encounter/2d975caf-e6bf-43c2-8778-ea293df1f255</td>
<td>2018-12-22T15:43:42-05:00</td>
<td>2018-12-22T15:43:42-05:00</td>
<td>2019-07-27T16:43:42-04:00</td>
</tr>
</tbody>
</table>

<p>639 rows × 15 columns</p>
</div>
</div>
</div>
</section>
<section id="group-export" class="level2">
<h2 class="anchored" data-anchor-id="group-export">Group export</h2>
<p><a href="https://www.healthit.gov/test-method/standardized-api-patient-and-population-services">§170.315(g)(10) Standardized API for patient and population services</a> requires <a href="https://hl7.org/fhir/uv/bulkdata/OperationDefinition-group-export.html"><code>group-export</code></a> as of December 2022.</p>
<p>This is therefore the FHIR Bulk Data endpoint you are likely to find in EHRs.</p>
<p>To use this endpoint, you will need the ID of the group of patients you want to export. In a production setting, this would typically be provided by the administrators of the EHR.</p>
<p>For the <code>bulk-data.smarthealthit.org</code> testing server, we can ask it for a list of groups via the FHIR API:</p>
<div id="3c69b5bb" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> session.get(<span class="ss">f'</span><span class="sc">{</span>server_url<span class="sc">}</span><span class="ss">/Group'</span>, headers<span class="op">=</span>{<span class="st">'Authorization'</span>: <span class="ss">f'Bearer </span><span class="sc">{</span>get_token()<span class="sc">}</span><span class="ss">'</span>, <span class="st">'Accept'</span>: <span class="st">'application/fhir+json'</span>})</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>r.json()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>{'resourceType': 'Bundle',
 'id': 'e21c6a557591d81d35d3f3bae22e6b490c71ad36b1b75b163393ea102e47eae8',
 'meta': {'lastUpdated': '2023-06-13 01:26:34'},
 'type': 'searchset',
 'total': 8,
 'link': [{'relation': 'self',
   'url': 'https://bulk-data.smarthealthit.org/fhir/Group'}],
 'entry': [{'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/1f76e2b7-a222-4765-9097-a71b86e90d07',
   'resource': {'resourceType': 'Group',
    'id': '1f76e2b7-a222-4765-9097-a71b86e90d07',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': '1f76e2b7-a222-4765-9097-a71b86e90d07'}],
    'quantity': 25,
    'name': 'Health New England',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Health New England&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/84e2fc85-2b9b-4680-b7df-cfbc2ea7a12b',
   'resource': {'resourceType': 'Group',
    'id': '84e2fc85-2b9b-4680-b7df-cfbc2ea7a12b',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': '84e2fc85-2b9b-4680-b7df-cfbc2ea7a12b'}],
    'quantity': 3,
    'name': 'Minuteman Health',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Minuteman Health&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/a1f090cb-ffd1-436d-a815-fb047d9a1903',
   'resource': {'resourceType': 'Group',
    'id': 'a1f090cb-ffd1-436d-a815-fb047d9a1903',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'a1f090cb-ffd1-436d-a815-fb047d9a1903'}],
    'quantity': 10,
    'name': 'BMC HealthNet',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;BMC HealthNet&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/a95907b4-0c41-462a-bfcf-cb822075eb39',
   'resource': {'resourceType': 'Group',
    'id': 'a95907b4-0c41-462a-bfcf-cb822075eb39',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'a95907b4-0c41-462a-bfcf-cb822075eb39'}],
    'quantity': 3,
    'name': 'Harvard Pilgrim Health Care',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Harvard Pilgrim Health Care&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/ae6ad3d7-f19d-44d7-9e70-fd0b7cf915e7',
   'resource': {'resourceType': 'Group',
    'id': 'ae6ad3d7-f19d-44d7-9e70-fd0b7cf915e7',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'ae6ad3d7-f19d-44d7-9e70-fd0b7cf915e7'}],
    'quantity': 22,
    'name': 'Tufts Health Plan',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Tufts Health Plan&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/b058c5e7-209c-4162-9289-0ff703347c0f',
   'resource': {'resourceType': 'Group',
    'id': 'b058c5e7-209c-4162-9289-0ff703347c0f',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'b058c5e7-209c-4162-9289-0ff703347c0f'}],
    'quantity': 3,
    'name': 'Fallon Health',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Fallon Health&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/cf04e363-eef4-4653-9650-846bca43f357',
   'resource': {'resourceType': 'Group',
    'id': 'cf04e363-eef4-4653-9650-846bca43f357',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'cf04e363-eef4-4653-9650-846bca43f357'}],
    'quantity': 7,
    'name': 'Neighborhood Health Plan',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Neighborhood Health Plan&lt;/div&gt;'},
    'type': 'person',
    'actual': True}},
  {'fullUrl': 'https://bulk-data.smarthealthit.org/fhir/Group/ff7dc35f-79e9-47a0-af22-475cf301a085',
   'resource': {'resourceType': 'Group',
    'id': 'ff7dc35f-79e9-47a0-af22-475cf301a085',
    'identifier': [{'system': 'https://bulk-data/db-id',
      'value': 'ff7dc35f-79e9-47a0-af22-475cf301a085'}],
    'quantity': 27,
    'name': 'Blue Cross Blue Shield',
    'text': {'status': 'generated',
     'div': '&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Blue Cross Blue Shield&lt;/div&gt;'},
    'type': 'person',
    'actual': True}}]}</code></pre>
</div>
</div>
<p>Let’s quickly pull this into a Pandas DataFrame to make it easier to read:</p>
<div id="7d9ab479" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>groups <span class="op">=</span> pd.json_normalize(r.json()[<span class="st">'entry'</span>])[[<span class="st">'resource.id'</span>, <span class="st">'resource.name'</span>, <span class="st">'resource.quantity'</span>]]</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resource.id</th>
<th data-quarto-table-cell-role="th">resource.name</th>
<th data-quarto-table-cell-role="th">resource.quantity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1f76e2b7-a222-4765-9097-a71b86e90d07</td>
<td>Health New England</td>
<td>25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>84e2fc85-2b9b-4680-b7df-cfbc2ea7a12b</td>
<td>Minuteman Health</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>a1f090cb-ffd1-436d-a815-fb047d9a1903</td>
<td>BMC HealthNet</td>
<td>10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>a95907b4-0c41-462a-bfcf-cb822075eb39</td>
<td>Harvard Pilgrim Health Care</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>ae6ad3d7-f19d-44d7-9e70-fd0b7cf915e7</td>
<td>Tufts Health Plan</td>
<td>22</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>b058c5e7-209c-4162-9289-0ff703347c0f</td>
<td>Fallon Health</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>cf04e363-eef4-4653-9650-846bca43f357</td>
<td>Neighborhood Health Plan</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>ff7dc35f-79e9-47a0-af22-475cf301a085</td>
<td>Blue Cross Blue Shield</td>
<td>27</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now we can request the patients and associated data for a specific group:</p>
<div id="01c27e11" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>group_id <span class="op">=</span> groups.loc[<span class="dv">0</span>, <span class="st">'resource.id'</span>]</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>fetcher <span class="op">=</span> BulkDataFetcher(</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    base_url<span class="op">=</span>server_url, client_id<span class="op">=</span>client_id, private_key<span class="op">=</span>private_key, key_id<span class="op">=</span>key_id, session<span class="op">=</span>session,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tell the BulkDataFetcher to request data from the specified group rather than all patients</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    endpoint<span class="op">=</span><span class="ss">f'Group/</span><span class="sc">{</span>group_id<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># add a resource type of interest, with some FHIRPath field mappings</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Patient'</span>, [</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>),</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"gender"</span>, <span class="st">"gender"</span>),</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>),</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding.first().code"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># add another resource type, with no FHIRPath mappings (load the entire resource)</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Condition'</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> fetcher.get_dataframes()</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Fetching from 
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZWw</span>
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">iOjB9/fhir/Group/1f76e2b7-a222-4765-9097-a71b86e90d07/$export?_type=Patient,Condition</span>
</pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">gender</th>
<th data-quarto-table-cell-role="th">date_of_birth</th>
<th data-quarto-table-cell-role="th">marital_status</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>female</td>
<td>1942-07-04</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>female</td>
<td>1967-10-24</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>male</td>
<td>2013-05-25</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>female</td>
<td>1959-07-23</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>84d4bafe-1891-4e6c-b8aa-38d2eafd8193</td>
<td>female</td>
<td>2000-09-12</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>4bc3ef6a-65c5-470d-8911-f26194b2a0e3</td>
<td>male</td>
<td>2004-08-20</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>3ca9f003-e6dd-4110-b4c2-12c056b880f4</td>
<td>female</td>
<td>1991-12-27</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>daf4e787-0ea5-45ff-a9a1-c68308e9f6a3</td>
<td>male</td>
<td>1995-06-21</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>1ad52ff0-428a-4048-aff8-f7196a2da649</td>
<td>female</td>
<td>1996-09-11</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>644d85af-aaf9-4068-ad23-1e55aedd5205</td>
<td>male</td>
<td>2003-09-12</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>687eb477-32ae-44ac-a0ef-2912623a14ff</td>
<td>female</td>
<td>1960-10-18</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>70ac5078-22ef-471d-bed7-cb694775b4ba</td>
<td>female</td>
<td>2001-08-25</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>7646ecba-4812-452e-88e7-6235f77dabb2</td>
<td>female</td>
<td>1997-11-20</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>69071541-e760-4d0c-bf8a-961a061cb0d5</td>
<td>male</td>
<td>1952-02-23</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>221fe1ec-a258-4fc4-8cc8-b7c960a8a0a9</td>
<td>female</td>
<td>2008-01-04</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>32e46528-35d1-4ed7-9aaa-09ae00f9681c</td>
<td>male</td>
<td>2007-02-12</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>b20c7c80-49ac-4926-8b03-e9c69b40e1f5</td>
<td>male</td>
<td>1951-04-26</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>733abdda-2bfa-485f-9c83-ed9b206889b2</td>
<td>male</td>
<td>1972-02-27</td>
<td>M</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>55940999-fd98-4922-b9bc-a6bf0c1855ed</td>
<td>male</td>
<td>1931-04-18</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>male</td>
<td>2002-05-10</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>ff9d23d8-f3c8-4eee-a5f9-e05e843675b5</td>
<td>female</td>
<td>1993-02-09</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>male</td>
<td>1991-10-27</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">22</td>
<td>8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>female</td>
<td>1962-08-01</td>
<td>M</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">23</td>
<td>d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>male</td>
<td>1979-11-11</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>male</td>
<td>1966-02-07</td>
<td>M</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>A number of different FHIR resources are available from the test server:</p>
<ul>
<li><a href="https://hl7.org/fhir/R4/allergyintolerance.html">AllergyIntolerance</a></li>
<li><a href="https://hl7.org/fhir/R4/careplan.html">CarePlan</a></li>
<li><a href="https://hl7.org/fhir/R4/careteam.html">CareTeam</a></li>
<li><a href="https://hl7.org/fhir/R4/claim.html">Claim</a></li>
<li><a href="https://hl7.org/fhir/R4/condition.html">Condition</a></li>
<li><a href="https://hl7.org/fhir/R4/device.html">Device</a></li>
<li><a href="https://hl7.org/fhir/R4/diagnosticreport.html">DiagnosticReport</a></li>
<li><a href="https://hl7.org/fhir/R4/documentreference.html">DocumentReference</a></li>
<li><a href="https://hl7.org/fhir/R4/encounter.html">Encounter</a></li>
<li><a href="https://hl7.org/fhir/R4/explanationofbenefit.html">ExplanationOfBenefit</a></li>
<li><a href="https://hl7.org/fhir/R4/imagingstudy.html">ImagingStudy</a></li>
<li><a href="https://hl7.org/fhir/R4/immunization.html">Immunization</a></li>
<li><a href="https://hl7.org/fhir/R4/medicationrequest.html">MedicationRequest</a></li>
<li><a href="https://hl7.org/fhir/R4/observation.html">Observation</a></li>
<li><a href="https://hl7.org/fhir/R4/patient.html">Patient</a></li>
<li><a href="https://hl7.org/fhir/R4/procedure.html">Procedure</a></li>
</ul>
<p>Try modifying the request above to pull in resource types other than <code>Patient</code> and <code>Condition</code>. The links above go to the FHIR documentation for each resource type, which can help with constructing FHIRPaths.</p>
<div id="a130f585" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try adding an additional resources</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>fetcher.add_resource_type(<span class="st">'Observation'</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> fetcher.get_dataframes()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Observation'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Fetching from 
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">https://bulk-data.smarthealthit.org/eyJlcnIiOiIiLCJwYWdlIjoxMDAwMCwiZHVyIjoxMCwidGx0IjoxNSwibSI6MSwic3R1Ijo0LCJkZWw</span>
<span style="color: #0000ff; text-decoration-color: #0000ff; text-decoration: underline">iOjB9/fhir/Group/1f76e2b7-a222-4765-9097-a71b86e90d07/$export?_type=Patient,Condition,Observation</span>
</pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="25">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">resourceType</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">category_0_coding_0_system</th>
<th data-quarto-table-cell-role="th">category_0_coding_0_code</th>
<th data-quarto-table-cell-role="th">category_0_coding_0_display</th>
<th data-quarto-table-cell-role="th">code_coding_0_system</th>
<th data-quarto-table-cell-role="th">code_coding_0_code</th>
<th data-quarto-table-cell-role="th">code_coding_0_display</th>
<th data-quarto-table-cell-role="th">code_text</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">component_1_valueQuantity_system</th>
<th data-quarto-table-cell-role="th">component_1_valueQuantity_code</th>
<th data-quarto-table-cell-role="th">valueCodeableConcept_coding_0_system</th>
<th data-quarto-table-cell-role="th">valueCodeableConcept_coding_0_code</th>
<th data-quarto-table-cell-role="th">valueCodeableConcept_coding_0_display</th>
<th data-quarto-table-cell-role="th">valueCodeableConcept_text</th>
<th data-quarto-table-cell-role="th">code_coding_1_system</th>
<th data-quarto-table-cell-role="th">code_coding_1_code</th>
<th data-quarto-table-cell-role="th">code_coding_1_display</th>
<th data-quarto-table-cell-role="th">valueString</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Observation</td>
<td>7a10d1ef-97f2-468b-b3ab-78dc99c65cf6</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>vital-signs</td>
<td>vital-signs</td>
<td>http://loinc.org</td>
<td>8302-2</td>
<td>Body Height</td>
<td>Body Height</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Observation</td>
<td>168c33d9-b4c8-4783-b97a-82fee9625f35</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>vital-signs</td>
<td>vital-signs</td>
<td>http://loinc.org</td>
<td>72514-3</td>
<td>Pain severity - 0-10 verbal numeric rating [Sc...</td>
<td>Pain severity - 0-10 verbal numeric rating [Sc...</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Observation</td>
<td>7a6ee07e-72d0-4a74-896f-13c1b2e9b254</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>vital-signs</td>
<td>vital-signs</td>
<td>http://loinc.org</td>
<td>29463-7</td>
<td>Body Weight</td>
<td>Body Weight</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Observation</td>
<td>fe4863c9-ac4e-439d-9d8f-834f1aebd3d8</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>vital-signs</td>
<td>vital-signs</td>
<td>http://loinc.org</td>
<td>39156-5</td>
<td>Body Mass Index</td>
<td>Body Mass Index</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Observation</td>
<td>a7e89580-6be8-4b0a-a528-dfb91f2508bf</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>vital-signs</td>
<td>vital-signs</td>
<td>http://loinc.org</td>
<td>85354-9</td>
<td>Blood Pressure</td>
<td>Blood Pressure</td>
<td>...</td>
<td>http://unitsofmeasure.org</td>
<td>mm[Hg]</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4024</td>
<td>Observation</td>
<td>6f4249dd-abeb-43dd-b388-407fff8ea4f8</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>laboratory</td>
<td>laboratory</td>
<td>http://loinc.org</td>
<td>1920-8</td>
<td>Aspartate aminotransferase [Enzymatic activity...</td>
<td>Aspartate aminotransferase [Enzymatic activity...</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4025</td>
<td>Observation</td>
<td>a04bc225-ad1c-4235-b792-1abde0cb5055</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>laboratory</td>
<td>laboratory</td>
<td>http://loinc.org</td>
<td>2093-3</td>
<td>Total Cholesterol</td>
<td>Total Cholesterol</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4026</td>
<td>Observation</td>
<td>1b26f91e-68d2-4630-a1e0-d2aba21ed4f6</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>laboratory</td>
<td>laboratory</td>
<td>http://loinc.org</td>
<td>2571-8</td>
<td>Triglycerides</td>
<td>Triglycerides</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4027</td>
<td>Observation</td>
<td>e43ed8c1-0535-407a-abd0-41dd09be6d4a</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>laboratory</td>
<td>laboratory</td>
<td>http://loinc.org</td>
<td>18262-6</td>
<td>Low Density Lipoprotein Cholesterol</td>
<td>Low Density Lipoprotein Cholesterol</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4028</td>
<td>Observation</td>
<td>b8c6b918-95b6-43f9-9524-78371a931384</td>
<td>final</td>
<td>http://terminology.hl7.org/CodeSystem/observat...</td>
<td>laboratory</td>
<td>laboratory</td>
<td>http://loinc.org</td>
<td>2085-9</td>
<td>High Density Lipoprotein Cholesterol</td>
<td>High Density Lipoprotein Cholesterol</td>
<td>...</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

<p>4029 rows × 42 columns</p>
</div>
</div>
</div>
<div id="81707814" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Try filtering to just Observations of smoking status</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># `fetcher.reprocess_dataframes()` does the same thing as `get_dataframes()`,</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># but with FHIRPaths and without re-downloading everything</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> fetcher.reprocess_dataframes({</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Patient'</span>: [</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"id"</span>, <span class="st">"identifier[0].value"</span>),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"gender"</span>, <span class="st">"gender"</span>),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"date_of_birth"</span>, <span class="st">"birthDate"</span>),</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"marital_status"</span>, <span class="st">"maritalStatus.coding.first().code"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Observation'</span>: [</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"id"</span>, <span class="st">"id"</span>),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"patient"</span>, <span class="st">"subject.reference"</span>),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"type"</span>, <span class="st">"code.coding.first().code"</span>),</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"type_display"</span>, <span class="st">"code.coding.first().display"</span>),</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"code"</span>, <span class="st">"valueCodeableConcept.coding.first().code"</span>),</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        (<span class="st">"code_display"</span>, <span class="st">"valueCodeableConcept.coding.first().display"</span>),</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> pd.option_context(<span class="st">'display.max_rows'</span>, <span class="dv">100</span>, <span class="st">'display.min_rows'</span>, <span class="dv">100</span>):</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    display(dfs[<span class="st">'Observation'</span>][dfs[<span class="st">'Observation'</span>][<span class="st">'type'</span>] <span class="op">==</span> <span class="st">'72166-2'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">patient</th>
<th data-quarto-table-cell-role="th">type</th>
<th data-quarto-table-cell-role="th">type_display</th>
<th data-quarto-table-cell-role="th">code</th>
<th data-quarto-table-cell-role="th">code_display</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>51202a40-c62e-4727-bfef-b643869d0951</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">32</td>
<td>04cc91b0-4fd0-4244-9738-32c563116308</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">53</td>
<td>87cc17d0-3914-4e95-9344-b76e394dfae6</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">81</td>
<td>b10d3da1-249e-406d-90cb-9ac19314f823</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">98</td>
<td>a0e5b7d8-30a2-4952-ae7a-c0a8d49bc9f3</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">119</td>
<td>f843b2e7-6caf-4284-aa90-51c2d55c3c51</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">136</td>
<td>d070c5c5-2a0a-4fe9-ba57-0b7fde240f3b</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">153</td>
<td>64beef69-dd3c-46a1-b970-8a5dc95be927</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">185</td>
<td>b120c744-e1ec-49b9-b8b0-2a54455f410c</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">202</td>
<td>984b970a-b027-4778-a820-7f6c56761125</td>
<td>Patient/fbfec681-d357-4b28-b1d2-5db6434c7846</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">213</td>
<td>17378ae3-f3b7-418b-b8e1-7af2856a5eac</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">221</td>
<td>ec100afb-6dad-47e9-8a58-2ea28c1a5fb6</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">233</td>
<td>bdf0d1b0-d405-4dbe-acc3-855d6c38d0d2</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">252</td>
<td>8b4c3ebb-0f3b-4a9f-aca6-894df17a652d</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">260</td>
<td>db972319-bfa5-4d88-a562-3e71e94bafc1</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">273</td>
<td>88515b19-a75f-486e-af88-96222bd4ca18</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">281</td>
<td>2da712dc-da92-4f89-a36e-3aa8fc714d73</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">289</td>
<td>219df89c-b801-4d3d-bfc0-7b270ad22542</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">312</td>
<td>b99b0288-8c94-4126-a7e0-d1c8717e51a3</td>
<td>Patient/0b8a6ef0-07c8-48ca-804d-1e64f6e44b95</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">332</td>
<td>18e82af6-9bb3-4657-8ee6-b02bdb288476</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">341</td>
<td>45e97461-0051-4bf5-82df-a8c4a429f099</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">350</td>
<td>e84acd03-8ae3-4b82-95cf-25799c7c94b8</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">359</td>
<td>f3d3151e-9a5b-4227-9b28-89f9cb61ca90</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">368</td>
<td>c3364946-7957-4a88-8912-7dc8a9a1cfcd</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">377</td>
<td>cb400c7f-485e-4674-a3d8-4700543235ae</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">398</td>
<td>450e1f51-8765-431c-a795-40206ac5c9fa</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">425</td>
<td>4ab3823f-27c4-466c-ae57-16e914454522</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">434</td>
<td>23c9d6e1-71bf-4766-96df-65a3b0d25d05</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">445</td>
<td>187e50b4-ac94-48a1-b052-02b5549be600</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">456</td>
<td>a0e8bef3-8317-4930-858d-8dff3830ff13</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">468</td>
<td>30c32d11-4e9a-4feb-b352-2196792bb2cf</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">479</td>
<td>0145b24c-12c5-4ef2-a437-3efa9006f498</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">488</td>
<td>2b444657-c019-4434-a9d4-3e0f2f7cdd2f</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">509</td>
<td>73b8dc8c-91f8-41dd-a6ba-981c6ed12316</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">518</td>
<td>c83226df-6f61-4849-bcce-1eec0f56be74</td>
<td>Patient/62e03ae7-079c-4eda-9b5a-29440d3a015a</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">534</td>
<td>683a4889-8ee5-4f5b-befb-35ec22b13107</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">562</td>
<td>2735a667-d2cd-4491-9a32-0758ce0f48e9</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">583</td>
<td>f86585e1-ec12-4125-a254-2533ea3b9bba</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">600</td>
<td>495b7f39-53b4-4d98-884d-fe14e464a13a</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">637</td>
<td>12ea697f-c2b3-4539-80c7-2ed09c84da2b</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">658</td>
<td>3a4f53d6-3c82-4efb-b891-d6a866949e58</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">675</td>
<td>fb5ed249-16e5-4379-85e7-6b8300ee9548</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">723</td>
<td>ee6a13b1-b6d1-49ab-8eff-128dc7f40daf</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">760</td>
<td>ec72955c-b5ba-40b8-a67e-13b137d95cb7</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">822</td>
<td>71d62e29-789d-4417-95fa-b71292d2e685</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">859</td>
<td>6d191cde-5731-41e5-9197-5827fad6608c</td>
<td>Patient/7cdaae04-4ce7-4a6d-b6a3-5cddba9bc888</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">871</td>
<td>566c6a71-d7ee-49fa-88a4-2c5e6e1d1476</td>
<td>Patient/84d4bafe-1891-4e6c-b8aa-38d2eafd8193</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">880</td>
<td>55ffbd45-6042-4240-8f32-4cd10c1c6d48</td>
<td>Patient/84d4bafe-1891-4e6c-b8aa-38d2eafd8193</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">900</td>
<td>abd678ea-30d0-48b1-9f8e-4b96c952e55e</td>
<td>Patient/84d4bafe-1891-4e6c-b8aa-38d2eafd8193</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">910</td>
<td>c00b5394-c828-46d3-b81f-498b768c5c81</td>
<td>Patient/84d4bafe-1891-4e6c-b8aa-38d2eafd8193</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3094</td>
<td>1448ef79-0efb-49fd-a32e-8e4501d63654</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3103</td>
<td>70b64209-a5f0-4d9b-9b92-ca8d4e37ad20</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3128</td>
<td>518b9a78-3ed3-401e-8792-b1f5653da244</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3137</td>
<td>4a491920-5523-4e12-a178-ad7692aae555</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3146</td>
<td>eec65c1b-e59a-4e65-a311-2c0cd097b078</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3166</td>
<td>5559cf2a-1386-4a48-b889-29798870a3f4</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3190</td>
<td>62abe2b1-4b46-41e4-9784-05509fe2439b</td>
<td>Patient/7ba8d35f-3f70-48b9-b711-104374136ac7</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3199</td>
<td>9cc9a329-78d7-4b4c-9734-624576028f5f</td>
<td>Patient/ff9d23d8-f3c8-4eee-a5f9-e05e843675b5</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3208</td>
<td>aab937d5-dc7c-44f2-9328-c58039baeedb</td>
<td>Patient/ff9d23d8-f3c8-4eee-a5f9-e05e843675b5</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3228</td>
<td>c8321dcc-cba2-454e-a862-b692bf75455e</td>
<td>Patient/ff9d23d8-f3c8-4eee-a5f9-e05e843675b5</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3236</td>
<td>df310c44-a40d-4596-a16d-22ae9454e2d7</td>
<td>Patient/ff9d23d8-f3c8-4eee-a5f9-e05e843675b5</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3245</td>
<td>ebb48186-7b0c-4ea2-a4ee-1bc77bd40926</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3253</td>
<td>837fd4cb-10c3-4d89-b2c1-23be8a8572b6</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3262</td>
<td>e9eabd4c-3d45-45e8-b21e-0a479cb0530f</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3282</td>
<td>6a594967-b815-4650-82f6-eb404bfc7aaf</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3299</td>
<td>fe884b8b-04d9-4c3b-a710-f77d89d87bef</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3317</td>
<td>22d56cc5-7a0e-49cf-8483-97de08415e1c</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3334</td>
<td>6bcef563-1082-4398-85d1-86a8f6603141</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3351</td>
<td>6d9a0171-6e80-464f-8022-5b740af8a932</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3368</td>
<td>e5447fff-dee3-4e8a-9756-e11304fa7f82</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3396</td>
<td>df8ba6a0-a4e8-4983-b1fb-85a6e68d5d39</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3424</td>
<td>1c7ca98b-18a6-401a-b5f9-218d21455658</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3441</td>
<td>71029c58-cca3-45d6-8f2e-cfa1b225883c</td>
<td>Patient/8d3e1155-278a-4824-a7e0-fddb24c7c179</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3458</td>
<td>756e618d-9983-4da5-9023-6103c1d4f3c0</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3479</td>
<td>f70de159-6f5c-40fb-a3fd-90c722a51aa6</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3496</td>
<td>4ea513ae-7aaf-4e61-bfa1-4e82333e6788</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3524</td>
<td>21baef36-0caf-452e-a049-d624974a0739</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3545</td>
<td>74b3fc01-da0c-4043-b630-38bb679fbd42</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3562</td>
<td>2f7f598b-fe86-44c4-88c1-f4951b5f9560</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3580</td>
<td>938dcefa-4ffb-4757-b13a-7cd715bcd599</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3598</td>
<td>11f8c8fc-ecee-4ec3-9201-8c192f3f8449</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3619</td>
<td>5d0dabae-f225-4ac7-a9e5-ae1103720cde</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3647</td>
<td>437d29cc-02b8-48a3-bc00-4e895bcdddae</td>
<td>Patient/8c9fea57-6ded-47b0-88c9-75518430b572</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3667</td>
<td>0d4d8892-536d-4e3d-adea-690b9f6582ed</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3675</td>
<td>a563d054-0081-4432-8977-a5cde30e13de</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3687</td>
<td>0f7039d9-1ef2-4aac-8617-96e33f827a10</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3695</td>
<td>6e0600dc-f43a-48f8-87f6-45a0983c6d97</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3703</td>
<td>be1d1942-ae59-42db-914a-04cbc61cdcf3</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3726</td>
<td>82de3db7-2921-453d-bbc5-8c56d70d630f</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3734</td>
<td>07f06643-6409-404c-89f6-fe1eb0e8c8cc</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3742</td>
<td>5ec5a8fd-43e8-4835-bef4-c0a429745a59</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3754</td>
<td>2151a281-9eac-4f98-9a1d-3b30b169e2f2</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3762</td>
<td>889b8074-f24d-4b7d-aba3-474fed898bda</td>
<td>Patient/d2524ab6-4db9-440d-b588-6dcfcab89270</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>266919005</td>
<td>Never smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3801</td>
<td>f596e621-6fe7-4acf-a0a7-2a68a2a77b35</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3833</td>
<td>3e0ed4d8-7e00-42e0-8a7c-d9d6dd57e05d</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3881</td>
<td>4a32ee10-0c5c-4f1c-820a-9155ee04d060</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3909</td>
<td>8e5f48c0-651c-4f02-9a75-8268fa1c0b1b</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3952</td>
<td>3f033821-1193-4ecf-95eb-9cfc2fa21cc0</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3980</td>
<td>5368a223-6972-410f-a253-6be399479303</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4008</td>
<td>6d9ff554-d1cf-48bb-9487-7d132c3575af</td>
<td>Patient/f98b23bf-4443-46d0-9eaf-563e767cf948</td>
<td>72166-2</td>
<td>Tobacco smoking status NHIS</td>
<td>8517006</td>
<td>Former smoker</td>
</tr>
</tbody>
</table>

<p>258 rows × 6 columns</p>
</div>
</div>
</div>
</section>
<section id="creating-fhirpaths" class="level2">
<h2 class="anchored" data-anchor-id="creating-fhirpaths">Creating FHIRPaths</h2>
<p>It may be helpful to use an online tool like <a href="https://hl7.github.io/fhirpath.js/" class="uri">https://hl7.github.io/fhirpath.js/</a> to assist with creating FHIRPaths for filtering the FHIR resources down for creating DataFrames. (Note that you should not use tools like this with identified patient data.)</p>
<p>We have a convenience method to get an example resource in JSON format from the <code>fetcher</code> object:</p>
<div id="a2e3e866" class="cell" data-scrolled="true" data-execution_count="27">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(json.dumps(fetcher.get_example_resource(<span class="st">'Observation'</span>), indent<span class="op">=</span><span class="dv">4</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">"resourceType"</span>: <span style="color: #008000; text-decoration-color: #008000">"Observation"</span>,
    <span style="color: #008000; text-decoration-color: #008000">"id"</span>: <span style="color: #008000; text-decoration-color: #008000">"7a10d1ef-97f2-468b-b3ab-78dc99c65cf6"</span>,
    <span style="color: #008000; text-decoration-color: #008000">"status"</span>: <span style="color: #008000; text-decoration-color: #008000">"final"</span>,
    <span style="color: #008000; text-decoration-color: #008000">"category"</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">"coding"</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">"system"</span>: <span style="color: #008000; text-decoration-color: #008000">"http://terminology.hl7.org/CodeSystem/observation-category"</span>,
                    <span style="color: #008000; text-decoration-color: #008000">"code"</span>: <span style="color: #008000; text-decoration-color: #008000">"vital-signs"</span>,
                    <span style="color: #008000; text-decoration-color: #008000">"display"</span>: <span style="color: #008000; text-decoration-color: #008000">"vital-signs"</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">"code"</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">"coding"</span>: <span style="font-weight: bold">[</span>
            <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">"system"</span>: <span style="color: #008000; text-decoration-color: #008000">"http://loinc.org"</span>,
                <span style="color: #008000; text-decoration-color: #008000">"code"</span>: <span style="color: #008000; text-decoration-color: #008000">"8302-2"</span>,
                <span style="color: #008000; text-decoration-color: #008000">"display"</span>: <span style="color: #008000; text-decoration-color: #008000">"Body Height"</span>
            <span style="font-weight: bold">}</span>
        <span style="font-weight: bold">]</span>,
        <span style="color: #008000; text-decoration-color: #008000">"text"</span>: <span style="color: #008000; text-decoration-color: #008000">"Body Height"</span>
    <span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">"subject"</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">"reference"</span>: <span style="color: #008000; text-decoration-color: #008000">"Patient/fbfec681-d357-4b28-b1d2-5db6434c7846"</span>
    <span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">"encounter"</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">"reference"</span>: <span style="color: #008000; text-decoration-color: #008000">"Encounter/a65fee02-b183-4ae5-a9e2-5edf89a6f327"</span>
    <span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">"effectiveDateTime"</span>: <span style="color: #008000; text-decoration-color: #008000">"2010-11-20T02:52:44-05:00"</span>,
    <span style="color: #008000; text-decoration-color: #008000">"issued"</span>: <span style="color: #008000; text-decoration-color: #008000">"2010-11-20T02:52:44.074-05:00"</span>,
    <span style="color: #008000; text-decoration-color: #008000">"valueQuantity"</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">"value"</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">162.4</span>,
        <span style="color: #008000; text-decoration-color: #008000">"unit"</span>: <span style="color: #008000; text-decoration-color: #008000">"cm"</span>,
        <span style="color: #008000; text-decoration-color: #008000">"system"</span>: <span style="color: #008000; text-decoration-color: #008000">"http://unitsofmeasure.org"</span>,
        <span style="color: #008000; text-decoration-color: #008000">"code"</span>: <span style="color: #008000; text-decoration-color: #008000">"cm"</span>
    <span style="font-weight: bold">}</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<p>This can be copied and pasted into <a href="https://hl7.github.io/fhirpath.js/" class="uri">https://hl7.github.io/fhirpath.js/</a> to experiment with FHIRPaths. Note that the JavaScript library used on this testing website is not the same as the Python library used in this notebook, so there may be some implementation differences.</p>
</section>
<section id="testing-with-synthea-data" class="level2">
<h2 class="anchored" data-anchor-id="testing-with-synthea-data">Testing with Synthea data</h2>
<p>Having test data is very helpful when developing code that uses FHIR Bulk Data. The test data from <a href="https://bulk-data.smarthealthit.org" class="uri">https://bulk-data.smarthealthit.org</a> may not have all the data elements you need for a specific research use case. <a href="https://nih-odss.github.io/fhir-for-research/modules/synthea-overview">Synthea</a> can be used for generating customized synthetic data in FHIR format. Below we’ll look at how to load <code>.ndjson</code> from Synthea into this notebook and use <code>reprocess_dataframes()</code> with FHIRPaths to convert into Pandas DataFrames.</p>
<p>First, we’ll create a short class to mimic the functionality of <code>BulkDataFetcher</code> but with loading the <code>.ndjson</code> directly from disk rather than via a bulk data export.</p>
<div id="0b9964a4" class="cell" data-pycharm="{&quot;is_executing&quot;:true}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SyntheaDataFetcher:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ndjson_file_path):</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resources_by_type <span class="op">=</span> {}</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        num_lines <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> line <span class="kw">in</span> <span class="bu">open</span>(ndjson_file_path,<span class="st">'r'</span>))</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(ndjson_file_path, <span class="st">'r'</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> tqdm(<span class="bu">file</span>, total<span class="op">=</span>num_lines):</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                json_obj <span class="op">=</span> json.loads(line)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                this_resource_type <span class="op">=</span> json_obj[<span class="st">'resourceType'</span>]</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> this_resource_type <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.resources_by_type:</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.resources_by_type[this_resource_type] <span class="op">=</span> []</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.resources_by_type[this_resource_type].append(json_obj)</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Resources available: "</span>)</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>.join([<span class="st">'- '</span><span class="op">+</span> x <span class="cf">for</span> x <span class="kw">in</span> <span class="va">self</span>.resources_by_type.keys()]))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_example_resource(<span class="va">self</span>, resource_type: <span class="bu">str</span>, resource_id: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.resources_by_type <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"You need to run get_dataframes() first"</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> resource_type <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.resources_by_type:</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>resource_type<span class="sc">}</span><span class="ss"> not available. Try one of these: </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(<span class="va">self</span>.resources_by_type.keys())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> resource_id <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.resources_by_type[resource_type][<span class="dv">0</span>]</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        resource <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.resources_by_type[resource_type] <span class="cf">if</span> r[<span class="st">'id'</span>] <span class="op">==</span> resource_id]</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(resource) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> resource[<span class="dv">0</span>]</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"No </span><span class="sc">{</span>resource_type<span class="sc">}</span><span class="ss"> with id=</span><span class="sc">{</span>resource_id<span class="sc">}</span><span class="ss"> was found."</span>)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reprocess_dataframes(<span class="va">self</span>, user_fhir_paths):</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> BulkDataFetcher._reprocess_dataframes(<span class="va">self</span>.resources_by_type, user_fhir_paths)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Load in 40 patients of Synthea data.</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co"># The original data come from &lt;https://synthea.mitre.org/downloads&gt; &gt; 1K Sample Synthetic Patient Records, FHIR R4</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>synthea_fetcher <span class="op">=</span> SyntheaDataFetcher(<span class="st">'synthea_100.ndjson'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"edc6f44ada914f9e92e65db30a7c4dc1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Resources available: 
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">- Patient
- Organization
- Practitioner
- Encounter
- Condition
- Device
- Claim
- ExplanationOfBenefit
- CareTeam
- Goal
- CarePlan
- Observation
- Immunization
- DiagnosticReport
- Procedure
- MedicationRequest
- ImagingStudy
- AllergyIntolerance
- MedicationAdministration
</pre>
</div>
</div>
<p>Here is how to apply FHIRPaths to filter the Synthea data:</p>
<div id="ebf1bbde" class="cell" data-pycharm="{&quot;is_executing&quot;:true}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>dfs <span class="op">=</span> synthea_fetcher.reprocess_dataframes({<span class="st">'Patient'</span>: [(<span class="st">'id'</span>, <span class="st">'id'</span>)]})</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>dfs[<span class="st">'Patient'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>5cbc121b-cd71-4428-b8b7-31e53eba8184</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>adccf2c3-9dc4-4067-ba23-98982c4875da</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>31191928-6acb-4d73-931c-e601cc3a13fa</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>67816396-e325-496d-a6ec-c047756b7ce4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>b426b062-8273-4b93-a907-de3176c0567d</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">95</td>
<td>ae4c5b55-c704-4406-b353-285f9166a489</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">96</td>
<td>edb1ebc5-d629-4c43-acf5-b8d1c38d9bd2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">97</td>
<td>2d75e3a4-f0f6-45dd-8b57-75fb2f303c9e</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">98</td>
<td>ea95f498-7929-4d50-be55-9bf7baee3a8d</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">99</td>
<td>57ca2c16-7008-41e5-b338-4758b2fc46f0</td>
</tr>
</tbody>
</table>

<p>100 rows × 1 columns</p>
</div>
</div>
</div>
<p>You can also get a sample resource to look at the raw JSON:</p>
<div id="66f1ad8a" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(synthea_fetcher.get_example_resource(<span class="st">'Patient'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span>
    <span style="color: #008000; text-decoration-color: #008000">'resourceType'</span>: <span style="color: #008000; text-decoration-color: #008000">'Patient'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'id'</span>: <span style="color: #008000; text-decoration-color: #008000">'5cbc121b-cd71-4428-b8b7-31e53eba8184'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'status'</span>: <span style="color: #008000; text-decoration-color: #008000">'generated'</span>,
        <span style="color: #008000; text-decoration-color: #008000">'div'</span>: <span style="color: #008000; text-decoration-color: #008000">'&lt;div xmlns="http://www.w3.org/1999/xhtml"&gt;Generated by &lt;a </span>
<span style="color: #008000; text-decoration-color: #008000">href="https://github.com/synthetichealth/synthea"&gt;Synthea&lt;/a&gt;.Version identifier: v2.4.0-404-ge7ce2295\n .   Person</span>
<span style="color: #008000; text-decoration-color: #008000">seed: 6457100290386878904  Population seed: 0&lt;/div&gt;'</span>
    <span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/us/core/StructureDefinition/us-core-race'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'ombCategory'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'valueCoding'</span>: <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'urn:oid:2.16.840.1.113883.6.238'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'2106-3'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'White'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'text'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueString'</span>: <span style="color: #008000; text-decoration-color: #008000">'White'</span><span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'ombCategory'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'valueCoding'</span>: <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'urn:oid:2.16.840.1.113883.6.238'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'2186-5'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'Not Hispanic or Latino'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">}</span>,
                <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'text'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueString'</span>: <span style="color: #008000; text-decoration-color: #008000">'Not Hispanic or Latino'</span><span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/patient-mothersMaidenName'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'valueString'</span>: <span style="color: #008000; text-decoration-color: #008000">'Deadra347 Borer986'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'M'</span><span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/patient-birthPlace'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'valueAddress'</span>: <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'city'</span>: <span style="color: #008000; text-decoration-color: #008000">'Billerica'</span>, <span style="color: #008000; text-decoration-color: #008000">'state'</span>: <span style="color: #008000; text-decoration-color: #008000">'Massachusetts'</span>, <span style="color: #008000; text-decoration-color: #008000">'country'</span>: <span style="color: #008000; text-decoration-color: #008000">'US'</span><span style="font-weight: bold">}</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://synthetichealth.github.io/synthea/disability-adjusted-life-years'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'valueDecimal'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.062655945052095</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://synthetichealth.github.io/synthea/quality-adjusted-life-years'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'valueDecimal'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">58.93734405494791</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'identifier'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'https://github.com/synthetichealth/synthea'</span>, <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'2fa15bc7-8866-461a-9000-f739e425860a'</span><span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://terminology.hl7.org/CodeSystem/v2-0203'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'MR'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'Medical Record Number'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'Medical Record Number'</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hospital.smarthealthit.org'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'2fa15bc7-8866-461a-9000-f739e425860a'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://terminology.hl7.org/CodeSystem/v2-0203'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'SS'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'Social Security Number'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'Social Security Number'</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/sid/us-ssn'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'999-93-7537'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://terminology.hl7.org/CodeSystem/v2-0203'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'DL'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">"Driver's License"</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">"Driver's License"</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'urn:oid:2.16.840.1.113883.4.3.25'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'S99948707'</span>
        <span style="font-weight: bold">}</span>,
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'type'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
                    <span style="font-weight: bold">{</span>
                        <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://terminology.hl7.org/CodeSystem/v2-0203'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'PPN'</span>,
                        <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'Passport Number'</span>
                    <span style="font-weight: bold">}</span>
                <span style="font-weight: bold">]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'Passport Number'</span>
            <span style="font-weight: bold">}</span>,
            <span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://standardhealthrecord.org/fhir/StructureDefinition/passportNumber'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'X14078167X'</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'name'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'use'</span>: <span style="color: #008000; text-decoration-color: #008000">'official'</span>, <span style="color: #008000; text-decoration-color: #008000">'family'</span>: <span style="color: #008000; text-decoration-color: #008000">'Brekke496'</span>, <span style="color: #008000; text-decoration-color: #008000">'given'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'Aaron697'</span><span style="font-weight: bold">]</span>, <span style="color: #008000; text-decoration-color: #008000">'prefix'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'Mr.'</span><span style="font-weight: bold">]}]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'telecom'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'phone'</span>, <span style="color: #008000; text-decoration-color: #008000">'value'</span>: <span style="color: #008000; text-decoration-color: #008000">'555-677-3119'</span>, <span style="color: #008000; text-decoration-color: #008000">'use'</span>: <span style="color: #008000; text-decoration-color: #008000">'home'</span><span style="font-weight: bold">}]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'gender'</span>: <span style="color: #008000; text-decoration-color: #008000">'male'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'birthDate'</span>: <span style="color: #008000; text-decoration-color: #008000">'1945-12-10'</span>,
    <span style="color: #008000; text-decoration-color: #008000">'address'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                <span style="font-weight: bold">{</span>
                    <span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://hl7.org/fhir/StructureDefinition/geolocation'</span>,
                    <span style="color: #008000; text-decoration-color: #008000">'extension'</span>: <span style="font-weight: bold">[</span>
                        <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'latitude'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueDecimal'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">41.93879298871088</span><span style="font-weight: bold">}</span>,
                        <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'url'</span>: <span style="color: #008000; text-decoration-color: #008000">'longitude'</span>, <span style="color: #008000; text-decoration-color: #008000">'valueDecimal'</span>: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-71.06682353144593</span><span style="font-weight: bold">}</span>
                    <span style="font-weight: bold">]</span>
                <span style="font-weight: bold">}</span>
            <span style="font-weight: bold">]</span>,
            <span style="color: #008000; text-decoration-color: #008000">'line'</span>: <span style="font-weight: bold">[</span><span style="color: #008000; text-decoration-color: #008000">'894 Brakus Bypass'</span><span style="font-weight: bold">]</span>,
            <span style="color: #008000; text-decoration-color: #008000">'city'</span>: <span style="color: #008000; text-decoration-color: #008000">'Taunton'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'state'</span>: <span style="color: #008000; text-decoration-color: #008000">'Massachusetts'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'postalCode'</span>: <span style="color: #008000; text-decoration-color: #008000">'02718'</span>,
            <span style="color: #008000; text-decoration-color: #008000">'country'</span>: <span style="color: #008000; text-decoration-color: #008000">'US'</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>,
    <span style="color: #008000; text-decoration-color: #008000">'maritalStatus'</span>: <span style="font-weight: bold">{</span>
        <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[</span>
            <span style="font-weight: bold">{</span><span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'http://terminology.hl7.org/CodeSystem/v3-MaritalStatus'</span>, <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'S'</span>, <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'S'</span><span style="font-weight: bold">}</span>
        <span style="font-weight: bold">]</span>,
        <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'S'</span>
    <span style="font-weight: bold">}</span>,
    <span style="color: #008000; text-decoration-color: #008000">'multipleBirthBoolean'</span>: <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>,
    <span style="color: #008000; text-decoration-color: #008000">'communication'</span>: <span style="font-weight: bold">[</span>
        <span style="font-weight: bold">{</span>
            <span style="color: #008000; text-decoration-color: #008000">'language'</span>: <span style="font-weight: bold">{</span>
                <span style="color: #008000; text-decoration-color: #008000">'coding'</span>: <span style="font-weight: bold">[{</span><span style="color: #008000; text-decoration-color: #008000">'system'</span>: <span style="color: #008000; text-decoration-color: #008000">'urn:ietf:bcp:47'</span>, <span style="color: #008000; text-decoration-color: #008000">'code'</span>: <span style="color: #008000; text-decoration-color: #008000">'en-US'</span>, <span style="color: #008000; text-decoration-color: #008000">'display'</span>: <span style="color: #008000; text-decoration-color: #008000">'English'</span><span style="font-weight: bold">}]</span>,
                <span style="color: #008000; text-decoration-color: #008000">'text'</span>: <span style="color: #008000; text-decoration-color: #008000">'English'</span>
            <span style="font-weight: bold">}</span>
        <span style="font-weight: bold">}</span>
    <span style="font-weight: bold">]</span>
<span style="font-weight: bold">}</span>
</pre>
</div>
</div>
<section id="try-it-yourself" class="level3">
<h3 class="anchored" data-anchor-id="try-it-yourself">Try it yourself</h3>
<p>Using FHIRPath, create the necessary dataframes to answer the following questions:</p>
<ol type="1">
<li>How many patients in the dataset have ever received a flu vaccine?</li>
<li>What are the five most common conditions that patients have been diagnosed with? (Use only the first diagnosis of a given condition for each patient.)</li>
<li>What is the most common medication (in MedicationRequest), and what are the top 5 encounter types associated with these medications?</li>
</ol>
<p>Remember that you can look at the <a href="https://hl7.org/fhir/R4/resourcelist.html">FHIR resource documentation</a> to see what data elements are in each resource. You can also use <code>synthea_fetcher.get_example_resource('ResourceTypeHere')</code> with <a href="https://hl7.github.io/fhirpath.js/" class="uri">https://hl7.github.io/fhirpath.js/</a> for testing out FHIRPaths if needed.</p>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Through this exercise we built a reusable tool to connect to a FHIR server with Bulk Data capabilities, export a set of resource types, and convert that data into DataFrames for analysis.</p>


</section>

</main> <!-- /main -->
<!-- scripts.html -->
<!-- any content in this file is inserted right before </body> -->

<!-- Append index.html to any links ending with '/'

Example:

<a href="https://example.org/workshops/bulk-data/">

will turn into:

<a href="https://example.org/workshops/bulk-data/index.html">

This ensures consistent behavior across different deployment platforms
and enables other scripts like role-based module highlighting.
-->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("a[href]").forEach(link => {
      if( link.getAttribute("href").endsWith("/") ) {
        link.setAttribute("href", link.getAttribute("href") + "index.html");
      }
    })
  });
</script>

<!-- Fix a11y issues with side menu -->
<script>
const elements = document.querySelectorAll('.sidebar-menu-container a.sidebar-item-text[data-bs-toggle="collapse"], .sidebar-menu-container a.sidebar-item-toggle[data-bs-toggle="collapse"]')

elements.forEach(element => {
    element.setAttribute('role', 'group');
});
</script>

<!-- JSON Viewer
Intercept all instances of:

``` json
```

and replace it with a fancy JSON viewer. If the content is
invalid JSON then the default Quarto rendering will occur.
-->
<script type="text/javascript" src="https://unpkg.com/dompurify@3.0.1/dist/purify.min.js"></script> <!-- load JS Sanitizer -->
<script>
    function jsonViewer(json, collapsible=false) {
        let TEMPLATES = {
            item: '<div class="json_view__item"><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--%TYPE%">%VALUE%</div></div>',
            itemCollapsible: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>',
            itemCollapsibleOpen: '<label class="json_view__item json_view__item--collapsible"><input type="checkbox" checked class="json_view__toggle"/><div class="json_view__key">%KEY%</div><div class="json_view__value json_view__value--type-%TYPE%">%VALUE%</div>%CHILDREN%</label>'
        };

        function createItem(key, value, type){
            let element = TEMPLATES.item.replace('%KEY%', key);

            if((key == 'div') && (type=='string')) { // Removes Resource.text.div value (looks bloated)
                element = element.replace('%VALUE%', '...');
            } else if(type == 'string') {
                element = element.replace('%VALUE%', '"' + value + '"');
            } else {
                element = element.replace('%VALUE%', value);
            }

            element = element.replace('%TYPE%', type);

            return element;
        }

        function createCollapsibleItem(key, value, type, children){
            let tpl = 'itemCollapsible';

            if(collapsible) {
                tpl = 'itemCollapsibleOpen';
            }

            let element = TEMPLATES[tpl].replace('%KEY%', key);

            element = element.replace('%VALUE%', type);
            element = element.replace('%TYPE%', type);
            element = element.replace('%CHILDREN%', children);

            return element;
        }

        function handleChildren(key, value, type) {
            let html = '';

            for(let item in value) { 
                let _key = item,
                    _val = value[item];

                html += handleItem(_key, _val);
            }

            return createCollapsibleItem(key, value, type, html);
        }

        function handleItem(key, value) {
            let type = typeof value;
 
            if( Array.isArray( value ) ) {
                return handleChildren(key, value, "array");
            }

            if(typeof value === 'object') {        
                return handleChildren(key, value, type);
            }

            return createItem(key, value, type);
        }

        function parseObject(obj) {
            _result = '<div class="json_view">';

            for(let item in obj) { 
                let key = item,
                    value = obj[item];

                _result += handleItem(key, value);
            }

            _result += '</div>';

            return _result;
        }
        
        try {
            return parseObject(JSON.parse(json));
        }
        catch(err) {
            console.log("Could not render JSON viewer: ", err);
            console.log("for string: ", json);
            return null;
        }

    };


    function parseHTML(string) {
        let sanitized = DOMPurify.sanitize(string);
        let parser = new DOMParser();
        return parser.parseFromString(sanitized, "text/html").body.firstChild;
    }

    let jsonCodeBlocks = document.querySelectorAll("code.sourceCode.json");
    jsonCodeBlocks.forEach((jsonCode) => {
        let json = jsonCode.innerText;
        let codeBlock = jsonCode.parentNode.parentNode;
        let uid = codeBlock.id;
        let documentLocation = codeBlock.parentNode;
        let viewerHTML = jsonViewer(json, true);

        let tabContainer = parseHTML(`
          <div>
            <ul class="nav nav-tabs" id="${uid}Tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="${uid}ViewerTab" data-bs-toggle="tab" data-bs-target="#${uid}Viewer" type="button" role="tab" aria-controls="${uid}Viewer" aria-selected="true">Viewer</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="${uid}JsonTab" data-bs-toggle="tab" data-bs-target="#${uid}Json" type="button" role="tab" aria-controls="${uid}Json" aria-selected="false">JSON</button>
              </li>
            </ul>
            <div class="tab-content" id="${uid}TabContent" style="height:50vh;overflow:scroll;">
              <div class="tab-pane fade show active" id="${uid}Viewer" role="tabpanel" aria-labelledby="${uid}ViewerTab"></div>
              <div class="tab-pane fade" id="${uid}Json" role="tabpanel" aria-labelledby="${uid}JsonTab"></div>
            </div>
          </div>
        `)

        if( viewerHTML != null ) {
            documentLocation.replaceChild(tabContainer, codeBlock);

            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Viewer`).appendChild( parseHTML(viewerHTML) );
            tabContainer.querySelector(`div#${uid}TabContent div#${uid}Json`).appendChild(codeBlock);
        }
    });
</script>

<!-- Role-based Module Highlighting

For any *.qmd file with roles defined in frontmatter,
running script/update-module-role-map will generate
modules/mappings.js. Then any markup with class .highlight-by-role, i.e:

:::{.highlight-by-role}
 - [mod1](/mod1)
 - [mod2](/mod2)
 - [mod3](/mod3)
:::

will highlight the links in the list assigned to the users roles.

The user can select a role by pressing a button with data-role=*
attribute. The possible roles are:

Possible Roles:
  investigator
  research-leader
  informaticist
  software-engineer
  clinician-scientist
-->
<script>
const all_modules = document.querySelectorAll(".highlight-by-role ul li");

/* highlights modules corresponding to role via role_module_map
 * @param: string - role name in lower kebab case
 */
function select_modules(string) {
    // remove all highlights
    all_modules.forEach((li_node) => {
        var mark_node = li_node.firstChild;
        var a_node = mark_node.firstChild;

        if( mark_node.nodeName == "MARK" ) {
            li_node.removeChild(mark_node);
            li_node.appendChild(a_node);
        }
    });

    // add highlights based on role_module_map
    role_module_map.forEach((mapping) => {
        if( mapping.role == string ) {
            mapping.modules.forEach((interest_module) => {
                document.querySelectorAll(`li [href*="${interest_module.slug}"]`).forEach((interest_a_node) => {

                    //console.log("selecting module ", interest_a_node);

                    var interest_li_node = interest_a_node.parentNode;
                    var mark_node = document.createElement("mark");
                    interest_li_node.appendChild(mark_node);
                    mark_node.appendChild(interest_a_node);

                    //console.log("appended ", interest_a_node, " to ", mark_node);
                });
            });
            return;
        }
    })
}


// clears previously selected roles, highlights the selected role, and sets "role" in local storage
function select_role(role) {
    store.setItem("role", role);

    document.querySelectorAll("[data-role]").forEach((a_node) => {
        a_node.classList.remove("btn", "btn-sm", "btn-secondary", "fw-bold", "rounded");
        a_node.classList.add("btn-role");
    });

    var selected_a_node = document.querySelector(`[data-role="${role}"]`);
    selected_a_node.classList.add("btn", "btn-sm", "btn-secondary", "fw-bold", "rounded");
    selected_a_node.classList.remove("btn-role");
}


// trigger role selection on clicking <a data-role=...>
document.querySelectorAll("a[data-role]").forEach((role_link) => {
    role_link.addEventListener("click", (e) => {
        var role = e.target.dataset.role;
        select_role(role);
        select_modules(role);
    });
});

// set default role and execute select_role and select_modules once to make sure feature is working
window.addEventListener("load", () => {
    if( store.getItem("role") ) {
        select_role(store.getItem("role"));
        select_modules(store.getItem("role"));
    }
    else {
        const DEFAULT_ROLE = "research-leader";

        select_role(DEFAULT_ROLE);
        select_modules(DEFAULT_ROLE);
    }
});
</script>

<!-- Navigation Override

Overwrite Quarto's Next/Previous buttons to point to modules
for the user's role
-->
<script>
// Below function is usable by CC BY-SA 3.0 from https://stackoverflow.com/a/6475125
String.prototype.toTitleCase = function() {
  let i, j, str, lowers, uppers;
  str = this.replace(/([^\W_]+[^\s-]*) */g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });

  // Certain minor words should be left lowercase unless 
  // they are the first or last words in the string
  lowers = ['A', 'An', 'The', 'And', 'But', 'Or', 'For', 'Nor', 'As', 'At', 
  'By', 'For', 'From', 'In', 'Into', 'Near', 'Of', 'On', 'Onto', 'To', 'With'];
  for (i = 0, j = lowers.length; i < j; i++)
    str = str.replace(new RegExp('\\s' + lowers[i] + '\\s', 'g'), 
      function(txt) {
        return txt.toLowerCase();
      });

  // Certain words such as initialisms or acronyms should be left uppercase
  uppers = ['ID', 'TV', 'FHIR'];
  for (i = 0, j = uppers.length; i < j; i++)
    str = str.replace(new RegExp('\\b' + uppers[i] + '\\b', 'g'), 
      uppers[i].toUpperCase());

  return str;
}

// Custom Hack to overwrite Quarto's built in navigators
document.addEventListener("DOMContentLoaded", function() {
    // Get current module and role
    const current_module_slug = window.location.toString().split('/').pop().split('.')[0];
    const role = store.getItem("role");

    // Get next and prev modules data
    let prev_href, prev_text;
    let next_href, next_text;

    role_module_map.forEach((mapping) => {
        if( mapping.role == role ) {
            for(let i=0; i<mapping.modules.length; i++) {
                if( mapping.modules[i].slug == current_module_slug ) {
                    function slug_to_url(slug) {
                        if( window.location.pathname.includes('modules') ) {
                            // replace "modules/*" in current URL with "modules/<slug>.html"
                            return window.location.toString().replace(/modules\/.*/, "modules/" + slug + ".html");
                        }
                        else {
                            // this case is irrelevant since prev/next buttons are only role-based in modules
                            return window.location.toString() + "/modules/" + slug + ".html";
                        }
                    }

                    prev_href = (i > 0) ? slug_to_url(mapping.modules[i-1].slug) : null;
                    prev_text = (i > 0) ? mapping.modules[i-1].text : null;

                    next_href = (i+1 < mapping.modules.length) ? slug_to_url(mapping.modules[i+1].slug) : null;
                    next_text = (i+1 < mapping.modules.length) ? mapping.modules[i+1].text : null;
                }
            }
        }
    });


    // Overwrite prev link
    if( prev_href ) {
        const prev_link_elmt = document.querySelector(".page-navigation .nav-page-previous .pagination-link");
        const prev_text_elmt = document.querySelector(".page-navigation .nav-page-previous .pagination-link .nav-page-text");
        if( prev_link_elmt ) {

            prev_link_elmt.href = prev_href
            //prev_link_elmt.classList.add("btn", "btn-outline-custom", "rounded");
            //prev_link_elmt.parentNode.classList.toggle("nav-page");
            prev_text_elmt.innerText = prev_text;
        }
    }

    // Overwrite next link
    if( next_href ) {
        const next_link_elmt = document.querySelector(".page-navigation .nav-page-next .pagination-link");
        const next_text_elmt = document.querySelector(".page-navigation .nav-page-next .pagination-link .nav-page-text");

        if( next_link_elmt ) {
            next_link_elmt.href = next_href;
            //next_link_elmt.classList.add("btn", "btn-outline-custom", "rounded");
            //next_link_elmt.parentNode.classList.toggle("nav-page");
            next_text_elmt.innerText = next_text;
        }
    }

    // if document has #key-points then move pagination to next after it
    key_points = document.querySelector("#key-points");
    if( key_points ) {
        let page_nav = document.querySelector("nav.page-navigation");
        key_points.insertAdjacentElement("afterend", page_nav);
    }

});


// Override style of Quarto page navigation (prev/next buttons)
document.addEventListener("DOMContentLoaded", function() {

    const page_navigators = document.querySelectorAll(".pagination-link");
    page_navigators.forEach((node) => {

        node.classList.add("btn", "btn-outline-custom", "rounded");
        node.parentNode.classList.remove("nav-page");
        node.parentNode.parentNode.style.gridRow = "initial";
    });
});

// Set external links to open in a new tab
document.addEventListener("DOMContentLoaded", function() {
    var all_links = document.querySelectorAll('a');
    for (var i = 0; i < all_links.length; i++){
        var a = all_links[i];
        if(a.hostname != location.hostname) {
                a.target = '_blank';
        }
    }
})

</script>

<!-- Lightbox 

Intercept all instances of:

:::{#id .mermaid-lightbox data-caption='my caption'}
```{mermaid}
mermaid markdown content...
```
:::

and overwrite it with a popup lightbox for easy viewing of diagram.
Powered by GLightbox: https://github.com/biati-digital/glightbox
-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.1/dist/css/glightbox.min.css">
<script src="https://cdn.jsdelivr.net/gh/mcstudios/glightbox@3.3.1/dist/js/glightbox.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const mermaidElements = document.querySelectorAll('.mermaid-lightbox');

    mermaidElements.forEach(element => {
      const id = element.id;
      const caption = element.getAttribute('data-caption');

      const lightboxFigure = document.createElement('a');
      lightboxFigure.setAttribute('href', '#' + id);
      lightboxFigure.className = 'glightbox';
      lightboxFigure.setAttribute('data-description', caption);
      lightboxFigure.setAttribute('data-width', "90%");
      lightboxFigure.setAttribute('data-height', "90%");

      const clonedElement = element.cloneNode(true);
      lightboxFigure.appendChild(clonedElement);

      const figcaption = document.createElement('figcaption');
      figcaption.textContent = 'Click diagram to enlarge';
      lightboxFigure.appendChild(figcaption);

      element.parentNode.replaceChild(lightboxFigure, element);
    });

    // Initialize GLightbox
    const lightbox = GLightbox({
        selector: '.glightbox'
    });
  })
</script>

<!-- This script dynamically updates the copyright year in the footer -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Get the current year
    var currentYear = new Date().getFullYear();
    
    // Find the span element where we'll put the year
    var span = document.getElementById('current-year');
    
    if (span) {
        // If the span exists, update its content with the current year
        span.textContent = currentYear;
    }
    });
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/nih-odss\.github\.io\/fhir-for-research\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© <span id="current-year"></span> The MITRE Corporation / <a href="https://github.com/NIH-ODSS/fhir-for-research/README.md">License information</a><br>Approved for Public Release / Case #24-3701<br><br>HL7® and FHIR® are the registered trademarks of <a href="https://hl7.org">Health Level Seven International (HL7)</a>.<br>Use of the HL7 and FHIR trademarks does not constitute an HL7 endorsement of this website.</p>
<div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/nih-odss/fhir-for-research/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>